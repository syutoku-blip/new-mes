<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MES-AI-A 商品詳細</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #f3f4fa;
      --bg-card: #ffffff;
      --accent: #4b6bff;
      --accent-soft: #e0e7ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #dbeafe, #f9fafb 45%, #eef2ff 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 18px 32px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .header-title {
      font-size: 18px;
      font-weight: 650;
    }
    .header-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    .btn-back {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 12px;
      padding: 5px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15,23,42,0.06);
    }
    .btn-back:hover {
      background: #eef2ff;
    }

    .hero-card {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
      padding: 18px;
      border-radius: 16px;
      background: var(--bg-card);
      box-shadow: 0 12px 35px rgba(15,23,42,0.12);
      position: relative;
      overflow: hidden;
    }
    .hero-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(79,70,229,0.12), transparent 52%);
      pointer-events: none;
    }

    .hero-image-wrap {
      padding: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e0e7ff, #f9fafb);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hero-image-wrap img {
      max-width: 100%;
      max-height: 220px;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(15,23,42,0.25);
    }

    .hero-main {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .title {
      font-size: 18px;
      font-weight: 650;
      line-height: 1.4;
    }
    .rating {
      font-size: 12px;
      color: #f59e0b;
    }
    .asin-line {
      font-size: 13px;
      margin-top: 4px;
    }
    .asin-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
    .asin-link:hover { text-decoration: underline; }

    .cat-block {
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-muted);
    }
    .cat-label {
      font-weight: 600;
      color: #4b5563;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #dcfce7;
      color: #15803d;
      margin-top: 6px;
      margin-right: 4px;
    }

    .hero-meta-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .hero-meta-item {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.6);
      border: 1px solid #e5e7eb;
    }

    /* 下部エリア */
    .lower-layout {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 2.1fr 1.6fr;
      gap: 14px;
    }

    .info-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .info-card-title {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 2px;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      min-width: 140px;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4ff;
      border: 1px solid #e0e7ff;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .chip-label {
      font-size: 10px;
      color: var(--text-muted);
    }
    .chip-value {
      font-size: 12px;
      font-weight: 600;
    }

    .graph-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 12px 12px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }
    .graph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .graph-title {
      font-size: 12px;
      font-weight: 600;
      color: #1f2937;
    }
    .graph-sub {
      font-size: 11px;
      color: var(--text-muted);
    }
    .graph-toggle-row {
      margin-top: 2px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }
    .graph-toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .graph-toggle-row input {
      width: 13px;
      height: 13px;
    }

    .graph-canvas-wrap {
      margin-top: 6px;
      height: 240px;
    }

    .keepa-link {
      margin-top: 6px;
      font-size: 11px;
    }
    .keepa-link a {
      color: #2563eb;
      text-decoration: none;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
    }

    .small-note {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 960px) {
      .hero-card { grid-template-columns: 1fr; }
      .hero-image-wrap { justify-content: flex-start; }
      .lower-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="header">
    <div>
      <div class="header-title">MES-AI-A 商品詳細</div>
      <div class="header-sub" id="headerSubtitle">ASIN の読み込み中...</div>
    </div>
    <button class="btn-back" onclick="history.back()">
      ← 一覧に戻る
    </button>
  </div>

  <!-- 上部：画像＋基本情報 -->
  <div class="hero-card" id="heroCard">
    <div class="hero-image-wrap">
      <img id="heroImage" src="" alt="Product image">
    </div>
    <div class="hero-main">
      <div class="brand" id="brandLabel"></div>
      <div class="title" id="titleLabel"></div>
      <div class="rating" id="ratingLabel"></div>
      <div class="asin-line">
        ASIN： <a href="#" target="_blank" rel="noopener" id="asinLink" class="asin-link"></a>
      </div>
      <div class="cat-block" id="categoryBlock"></div>
      <div id="warningBadge"></div>
      <div class="hero-meta-row" id="heroMetaRow"></div>
    </div>
  </div>

  <!-- 下部：その他指標＋グラフ -->
  <div class="lower-layout">
    <!-- 左：横長項目 -->
    <div class="info-card">
      <div class="info-card-title">利益・価格・在庫のサマリー</div>
      <div class="chip-row" id="chipRow1"></div>

      <div class="info-card-title" style="margin-top:4px;">販売指標</div>
      <div class="chip-row" id="chipRow2"></div>

      <div class="info-card-title" style="margin-top:4px;">物流・コスト</div>
      <div class="chip-row" id="chipRow3"></div>
      <div class="small-note">※ 数値はダミーデータです。本番環境では API やスプレッドシートと連携して更新します。</div>
    </div>

    <!-- 右：グラフ -->
    <div class="graph-card">
      <div class="graph-header">
        <div>
          <div class="graph-title">需給推移（180日）</div>
          <div class="graph-sub">ランキング / セラー数 / 価格</div>
        </div>
        <div class="graph-sub" id="graphAsinLabel"></div>
      </div>
      <div class="graph-toggle-row">
        <label>
          <input type="checkbox" id="chkDemandSupply" checked>
          《需要＆供給》ランキング＋セラー数
        </label>
        <label>
          <input type="checkbox" id="chkSupplyPrice">
          《供給＆価格》セラー数＋価格
        </label>
      </div>
      <div class="graph-canvas-wrap">
        <canvas id="demandChart"></canvas>
      </div>
      <div class="keepa-link" id="keepaAnchor"></div>
      <div class="small-note">
        グラフ上にカーソルを合わせると、その時点の詳細な数値（ランキング・セラー数・価格）が表示されます。
      </div>
    </div>
  </div>
</div>

<script>
  /* --- ダミーASINデータ（一覧ページと同じ構造） --- */
  const ASIN_DATA = {
    "B0A0000001": {
      ASIN: "B0A0000001",
      "商品画像": "https://via.placeholder.com/240x240?text=Toy+Set",
      "品名": "スーパーアクションヒーロー 5体セット",
      "注意事項（警告系）": "対象年齢6歳以上 / 小さな部品に注意",
      "親カテゴリ": "Toys & Games",
      "サブカテゴリ": "Action Figures",
      "ブランド": "HeroWorks",
      "レビュー評価": "★★★★☆ (523)",
      "アメリカASIN": "B0A0000001",
      "日本ASIN": "B0J0000001",
      "JAN": "4900000000001",
      "SKU": "HW-HERO-SET-5",
      "個数": 1,
      "粗利益率予測": "26%",
      "入金額予測": "6,200円",
      "粗利益予測": "1,612円",
      "粗利益": "1,580円",
      "粗利益率": "25%",
      "販売額（ドル）": "$39.99",
      "入金額（円）": "6,200円",
      "入金額計（円）": "6,200円",
      "30日販売数": 95,
      "90日販売数": 260,
      "180日販売数": 510,
      "予測30日販売数": 110,
      "複数在庫指数45日分": "1.1",
      "複数在庫指数60日分": "1.3",
      "ライバル偏差1": "0.5",
      "ライバル偏差2": "0.9",
      "ライバル増加率": "12%",
      "在庫数": 60,
      "Keepaリンク": "https://keepa.com/#!product/1-B0A0000001",
      "FBA出品": "はい",
      "返品率": "1.8%",
      "過去3月FBA最安値": "$35.90",
      "カートボックス価格": "$39.99",
      "FBA最安値": "$37.50",
      "日本最安値": "¥6,780",
      "日本FBA最安値": "¥6,980",
      "日本自己発送最安値": "¥6,600",
      "仕入れ目安単価": "¥3,700",
      "仕入合計": "¥3,700",
      "仕入計": "¥3,700",
      "重量kg": "1.10",
      "サイズ感": "中型",
      "縦cm": 32,
      "横cm": 26,
      "高さcm": 8,
      "容積重量": "1.20",
      "材質": "プラスチック / 紙",
      "大型": "いいえ",
      "請求重量": "1.20kg",
      "想定送料": "¥1,150",
      "送料": "¥1,120",
      "関税": "¥0"
    },
    "B0A0000002": {
      ASIN: "B0A0000002",
      "商品画像": "https://via.placeholder.com/240x240?text=Puzzle",
      "品名": "ウルトラギャラクシーパズル 2000ピース",
      "注意事項（警告系）": "対象年齢12歳以上",
      "親カテゴリ": "Toys & Games",
      "サブカテゴリ": "Jigsaw Puzzles",
      "ブランド": "GalaxyMind",
      "レビュー評価": "★★★★☆ (312)",
      "アメリカASIN": "B0A0000002",
      "日本ASIN": "B0J0000002",
      "JAN": "4900000000002",
      "SKU": "GM-PUZZLE-2000",
      "個数": 1,
      "粗利益率予測": "30%",
      "入金額予測": "4,200円",
      "粗利益予測": "1,260円",
      "粗利益": "1,200円",
      "粗利益率": "29%",
      "販売額（ドル）": "$26.50",
      "入金額（円）": "4,200円",
      "入金額計（円）": "4,200円",
      "30日販売数": 70,
      "90日販売数": 190,
      "180日販売数": 370,
      "予測30日販売数": 80,
      "複数在庫指数45日分": "1.0",
      "複数在庫指数60日分": "1.1",
      "ライバル偏差1": "0.2",
      "ライバル偏差2": "0.4",
      "ライバル増加率": "5%",
      "在庫数": 45,
      "Keepaリンク": "https://keepa.com/#!product/1-B0A0000002",
      "FBA出品": "はい",
      "返品率": "1.1%",
      "過去3月FBA最安値": "$24.99",
      "カートボックス価格": "$26.50",
      "FBA最安値": "$25.20",
      "日本最安値": "¥3,980",
      "日本FBA最安値": "¥4,280",
      "日本自己発送最安値": "¥3,900",
      "仕入れ目安単価": "¥2,500",
      "仕入合計": "¥2,500",
      "仕入計": "¥2,500",
      "重量kg": "0.90",
      "サイズ感": "小型",
      "縦cm": 28,
      "横cm": 22,
      "高さcm": 6,
      "容積重量": "0.75",
      "材質": "紙",
      "大型": "いいえ",
      "請求重量": "0.90kg",
      "想定送料": "¥900",
      "送料": "¥880",
      "関税": "¥0"
    }
    /* 必要なら他の ASIN も追加 */
  };

  /* --- util: クエリ取得 --- */
  function getQueryParam(name) {
    const params = new URLSearchParams(location.search);
    return params.get(name);
  }

  /* --- 疑似乱数＋需給データ（一覧と同じロジック） --- */
  function createPRNG(seedStr) {
    let seed = 0;
    for (let i = 0; i < seedStr.length; i++) seed += seedStr.charCodeAt(i);
    return function () {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };
  }
  function getDemandSupplySeries(asin) {
    const rand = createPRNG(asin);
    const days = 180;
    const labels = [];
    const ranking = [];
    const sellers = [];
    const price = [];
    let rank = 60000 * (0.6 + rand() * 0.4);
    let seller = 5 + Math.round(rand() * 5);
    let p = 25 + rand() * 30;

    for (let i = days - 1; i >= 0; i--) {
      labels.push(`${i}日前`);
      rank += (rand() - 0.5) * 4000;
      rank = Math.max(5000, Math.min(80000, rank));
      seller += (rand() - 0.5) * 2;
      seller = Math.max(1, Math.min(25, seller));
      p += (rand() - 0.5) * 2;
      p = Math.max(10, Math.min(80, p));
      ranking.push(Math.round(rank));
      sellers.push(Number(seller.toFixed(1)));
      price.push(Number(p.toFixed(2)));
    }
    labels.reverse(); ranking.reverse(); sellers.reverse(); price.reverse();
    return { labels, ranking, sellers, price };
  }

  /* --- 画面への反映 --- */
  let demandChart;

  function renderDetail(asin) {
    const data = ASIN_DATA[asin];
    const headerSubtitle = document.getElementById("headerSubtitle");

    if (!data) {
      headerSubtitle.textContent = `ASIN: ${asin} のデータが見つかりません。`;
      document.getElementById("heroCard").style.display = "none";
      document.querySelector(".lower-layout").style.display = "none";
      return;
    }

    headerSubtitle.textContent = `ASIN: ${asin} の詳細ビュー`;

    // 上部
    document.getElementById("heroImage").src = data["商品画像"] || "https://via.placeholder.com/240x240?text=No+Image";
    document.getElementById("brandLabel").textContent = data["ブランド"] || "";
    document.getElementById("titleLabel").textContent = data["品名"] || "";
    document.getElementById("ratingLabel").textContent = data["レビュー評価"] || "";

    const asinLink = document.getElementById("asinLink");
    asinLink.textContent = data["アメリカASIN"] || asin;
    asinLink.href = `https://www.amazon.com/dp/${data["アメリカASIN"] || asin}`;

    const catBlock = document.getElementById("categoryBlock");
    catBlock.innerHTML =
      `<span class="cat-label">【カテゴリ】</span><br>` +
      `親：${data["親カテゴリ"] || "-"}<br>` +
      `子：${data["サブカテゴリ"] || "-"}`;

    const warningDiv = document.getElementById("warningBadge");
    warningDiv.innerHTML = "";
    if (data["注意事項（警告系）"]) {
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = data["注意事項（警告系）"];
      warningDiv.appendChild(span);
    }

    const heroMetaRow = document.getElementById("heroMetaRow");
    heroMetaRow.innerHTML = "";
    const metaItems = [
      ["SKU", data["SKU"]],
      ["JAN", data["JAN"]],
      ["日本ASIN", data["日本ASIN"]],
      ["FBA出品", data["FBA出品"]],
    ];
    metaItems.forEach(([label, val]) => {
      if (!val) return;
      const div = document.createElement("div");
      div.className = "hero-meta-item";
      div.textContent = `${label}: ${val}`;
      heroMetaRow.appendChild(div);
    });

    // 下：チップ
    const chipRow1 = document.getElementById("chipRow1");
    chipRow1.innerHTML = "";
    const chipRow2 = document.getElementById("chipRow2");
    chipRow2.innerHTML = "";
    const chipRow3 = document.getElementById("chipRow3");
    chipRow3.innerHTML = "";

    function addChip(rowEl, label, value) {
      const chip = document.createElement("div");
      chip.className = "chip";
      const l = document.createElement("div");
      l.className = "chip-label";
      l.textContent = label;
      const v = document.createElement("div");
      v.className = "chip-value";
      v.textContent = value || "-";
      chip.appendChild(l);
      chip.appendChild(v);
      rowEl.appendChild(chip);
    }

    // 利益・価格
    addChip(chipRow1, "販売額（ドル）", data["販売額（ドル）"]);
    addChip(chipRow1, "カートボックス価格", data["カートボックス価格"]);
    addChip(chipRow1, "粗利益率予測", data["粗利益率予測"]);
    addChip(chipRow1, "粗利益予測", data["粗利益予測"]);
    addChip(chipRow1, "仕入れ目安単価", data["仕入れ目安単価"]);
    addChip(chipRow1, "在庫数", data["在庫数"]);

    // 販売指標
    addChip(chipRow2, "30日販売数", data["30日販売数"]);
    addChip(chipRow2, "90日販売数", data["90日販売数"]);
    addChip(chipRow2, "180日販売数", data["180日販売数"]);
    addChip(chipRow2, "予測30日販売数", data["予測30日販売数"]);
    addChip(
      chipRow2,
      "複数在庫指数",
      `45日：${data["複数在庫指数45日分"] ?? "-"} / 60日：${data["複数在庫指数60日分"] ?? "-"}`
    );
    addChip(
      chipRow2,
      "ライバル偏差",
      `×1：${data["ライバル偏差1"] ?? "-"} / ×2：${data["ライバル偏差2"] ?? "-"}`
    );

    // 物流・コスト
    addChip(chipRow3, "重量(kg)", data["重量kg"]);
    if (data["縦cm"] != null && data["横cm"] != null && data["高さcm"] != null) {
      addChip(chipRow3, "サイズ(縦×横×高)", `${data["縦cm"]}×${data["横cm"]}×${data["高さcm"]} cm`);
    }
    addChip(chipRow3, "容積重量", data["容積重量"]);
    addChip(chipRow3, "想定送料", data["想定送料"]);
    addChip(chipRow3, "送料", data["送料"]);
    addChip(chipRow3, "関税", data["関税"]);

    // Keepa
    const keepaAnchor = document.getElementById("keepaAnchor");
    keepaAnchor.innerHTML = "";
    if (data["Keepaリンク"]) {
      keepaAnchor.innerHTML = `<a href="${data["Keepaリンク"]}" target="_blank" rel="noopener">Keepa で詳細を見る</a>`;
    }

    // グラフ
    const graphLabel = document.getElementById("graphAsinLabel");
    graphLabel.textContent = `ASIN: ${asin}`;

    const series = getDemandSupplySeries(asin);
    if (demandChart) {
      demandChart.destroy();
    }
    const ctx = document.getElementById("demandChart").getContext("2d");
    demandChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: series.labels,
        datasets: [
          { label: "ランキング（小さいほど上位）", data: series.ranking, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: series.sellers, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格（USD）", data: series.price, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label || "";
                if (ctx.dataset.yAxisID === "yPrice") {
                  return `${label}: $${ctx.parsed.y.toFixed(2)}`;
                }
                return `${label}: ${ctx.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: { display: true, ticks: { maxTicksLimit: 10 } },
          yRank: { type: "linear", position: "left", reverse: true, title: { display: true, text: "ランキング" } },
          ySeller: { type: "linear", position: "right", title: { display: true, text: "セラー数" }, grid: { drawOnChartArea: false } },
          yPrice: { type: "linear", position: "right", offset: true, title: { display: true, text: "価格(USD)" }, grid: { drawOnChartArea: false } }
        }
      }
    });

    applyCheckboxVisibility(); // 初期表示
  }

  /* --- チェックボックスで線の ON/OFF --- */
  function applyCheckboxVisibility() {
    if (!demandChart) return;
    const demandOn = document.getElementById("chkDemandSupply").checked;
    const supplyOn = document.getElementById("chkSupplyPrice").checked;

    let showRank = true;
    let showSeller = true;
    let showPrice = true;

    if (demandOn && !supplyOn) {
      showRank = true; showSeller = true; showPrice = false;
    } else if (!demandOn && supplyOn) {
      showRank = false; showSeller = true; showPrice = true;
    } else if (demandOn && supplyOn) {
      showRank = true; showSeller = true; showPrice = true;
    } else {
      showRank = true; showSeller = true; showPrice = true;
    }

    demandChart.data.datasets[0].hidden = !showRank;
    demandChart.data.datasets[1].hidden = !showSeller;
    demandChart.data.datasets[2].hidden = !showPrice;
    demandChart.update();
  }

  document.getElementById("chkDemandSupply").addEventListener("change", applyCheckboxVisibility);
  document.getElementById("chkSupplyPrice").addEventListener("change", applyCheckboxVisibility);

  /* --- 初期化 --- */
  (function init() {
    const asin = (getQueryParam("asin") || "B0A0000001").toUpperCase();
    renderDetail(asin);
  })();
</script>
</body>
</html>

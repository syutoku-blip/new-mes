<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MES-AI-A 詳細ビュー</title>

  <!-- Chart.js（グラフ用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --bg-header: #4b6bff;
      --bg-header2: #eef1fb;
      --border: #d4d8ea;
      --accent: #4b6bff;
      --text-main: #111827;
      --text-muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }
    .app-shell { min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 14px 24px;
      background: linear-gradient(90deg, #4b6bff, #8a63ff);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 2px 10px rgba(15,23,42,.18);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: .03em;
    }
    header .subtitle {
      font-size: 12px;
      opacity: 0.9;
    }
    .status {
      font-size: 12px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar {
      padding: 10px 24px 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .toolbar label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .toolbar input[type="text"] {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      min-width: 140px;
    }
    .toolbar button {
      border-radius: 999px;
      border: none;
      font-size: 12px;
      padding: 6px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform .06s ease-out, box-shadow .06s ease-out;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 6px rgba(75,107,255,0.35);
    }
    .toolbar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(75,107,255,0.45);
    }

    .asin-catalog {
      padding: 0 24px 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .asin-catalog-label {
      margin-right: 4px;
      font-weight: 600;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 7px;
      border-radius: 999px;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 10px;
      font-weight: 600;
    }
    .pill-ok { background: #dcfce7; color: #15803d; }
    .pill-danger { background: #fee2e2; color: #b91c1c; }

    .page-body {
      flex: 1;
      padding: 10px 20px 24px;
      display: flex;
      justify-content: center;
    }
    .content {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* ====== 上段：1枠（画像のイメージ） ====== */
    .summary-card {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(15,23,42,.12);
      padding: 12px 14px;
      display: grid;
      grid-template-columns: minmax(260px, 1.1fr) minmax(200px,.8fr) minmax(320px,1.1fr);
      gap: 10px;
      min-height: 210px;
    }

    /* 左: 画像＋基本情報 */
    .summary-left {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 8px;
      align-items: start;
    }
    .summary-image-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .summary-image-box img {
      max-width: 90px;
      max-height: 110px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      object-fit: contain;
      background: #f9fafb;
    }
    .qty-row {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
    }
    .qty-row select {
      font-size: 10px;
      padding: 1px 4px;
    }
    .summary-basic {
      font-size: 11px;
    }
    .summary-basic-row {
      margin-bottom: 3px;
      display: flex;
      gap: 4px;
    }
    .summary-basic-label {
      min-width: 52px;
      color: var(--text-muted);
    }
    .summary-basic-value {
      font-weight: 500;
    }
    .summary-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    /* 注意事項タグ */
    .warning-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-top: 2px;
    }
    .warning-tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 1px 6px;
      color: #fff;
      font-weight: 600;
    }
    .warning-export-ban      { background:#ef4444; } /* 輸出不可: 赤 */
    .warning-ip              { background:#8b5cf6; } /* 知財: 紫 */
    .warning-large           { background:#f97316; } /* 大型: オレンジ */
    .warning-ship-ban        { background:#6b7280; } /* 出荷禁止: グレー */
    .warning-approval        { background:#0ea5e9; } /* 承認要: 青 */
    .warning-variation       { background:#22c55e; } /* バリエーション: 緑 */
    .warning-plain {
      background:#f97316;
    }

    /* 中央: 価格＆利益 */
    .summary-center {
      background: #fefce8;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 11px;
      border: 1px solid #facc15;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .center-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .center-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .center-row-label {
      color: var(--text-muted);
    }
    .center-row-value {
      font-weight: 600;
    }

    /* 右: グラフ箱 */
    .summary-right {
      background: #eff6ff;
      border-radius: 8px;
      padding: 6px 8px 8px;
      border: 1px solid #bfdbfe;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .graph-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }
    .graph-header-title {
      font-weight: 600;
      color: #1d4ed8;
    }
    .graph-options {
      font-size: 10px;
    }
    .graph-options label {
      display: block;
      cursor: pointer;
    }
    .graph-options input {
      width: 11px;
      height: 11px;
    }
    .graph-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .graph-canvas-wrap {
      flex: 1;
      min-height: 130px;
    }
    .graph-caption {
      font-size: 9px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 1px;
    }

    /* ====== プレースホルダー ====== */
    .detail-card {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(15,23,42,.08);
      padding: 10px 14px 12px;
    }
    .detail-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      border-left: 3px solid var(--accent);
      padding-left: 8px;
    }
    .placeholder {
      padding: 12px 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ====== その他の指標：テーブル ====== */
    .detail-table-wrapper {
      background: transparent;
    }
    .detail-table-container {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(15,23,42,.10);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .detail-table-header-bar {
      padding: 7px 10px;
      background: linear-gradient(90deg,#f9fafb,#eef2ff);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .detail-table-header-bar small {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 400;
    }
    .detail-hidden-bar {
      padding: 4px 10px 2px;
      display: none;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background:#f9fafb;
    }
    .detail-hidden-pill {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px dashed #c7d2fe;
      background:#eef2ff;
    }
    .detail-hidden-pill button {
      border:none;
      background:transparent;
      font-size:11px;
      color:#4f46e5;
      cursor:pointer;
    }

    .detail-table-scroll {
      overflow-x: auto;
      overflow-y: hidden;
    }
    table.detail-table {
      border-collapse: separate;
      border-spacing: 0;
      min-width: 900px;
      font-size: 10px;
      line-height: 1.3;
    }
    .detail-table thead {
      background: linear-gradient(180deg,var(--bg-card),var(--bg-header2));
    }
    .detail-table th,
    .detail-table td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
    }
    .detail-table th {
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 2;
      cursor: grab;
      user-select: none;
    }
    .detail-table th .th-inner {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .detail-table th .th-label {
      font-size:10px;
    }
    .detail-table th .th-toggle {
      border:none;
      background:transparent;
      font-size:11px;
      cursor:pointer;
      color:#9ca3af;
      padding:0 2px;
    }
    .detail-table th .th-toggle:hover {
      color:#ef4444;
    }
    .detail-table th.drag-over {
      outline:2px dashed #c7d2fe;
      background:#e5e7ff;
    }
    .detail-table-footer {
      padding: 5px 10px;
      font-size: 10px;
      color: var(--text-muted);
      border-top:1px solid var(--border);
      background:#f9fafb;
    }

    @media (max-width: 900px) {
      .summary-card { grid-template-columns: 1fr; }
      .summary-right { min-height: 190px; }
    }
    @media (max-width: 600px) {
      header { flex-direction: column; align-items: flex-start; }
      .toolbar { padding-inline: 16px; }
      .page-body { padding-inline: 10px; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div>
      <h1>MES-AI-A ASIN 詳細ビュー（2ページ目）</h1>
      <div class="subtitle">ASINを入力すると、上段1枠に基本情報＋利益＋180日グラフ、下段に横スクロール可能な詳細テーブルが表示されます。</div>
    </div>
    <div id="headerStatus" class="status"></div>
  </header>

  <div class="toolbar">
    <label for="asinInput">ASIN:</label>
    <input id="asinInput" type="text" placeholder="例）B0A0000001" />
    <button id="loadBtn">表示</button>
  </div>

  <!-- 登録済みASIN一覧 -->
  <div class="asin-catalog" id="asinCatalog"></div>

  <div class="page-body">
    <div class="content">
      <!-- 上段：1枠 -->
      <div id="summaryCard" class="summary-card" style="display:none;">
        <!-- 左 -->
        <div class="summary-left">
          <div class="summary-image-box">
            <img id="prodImage" src="" alt="商品画像" />
            <div class="qty-row">
              <span>数量</span>
              <select id="qtySelect">
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>
          <div class="summary-basic">
            <div id="basicTitle" class="summary-title"></div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">ブランド：</div>
              <div id="basicBrand" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">評価：</div>
              <div id="basicRating" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">ASIN：</div>
              <div id="basicASIN" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">カテゴリ：</div>
              <div class="summary-basic-value">
                <span id="basicCatParent"></span>
                <span> / </span>
                <span id="basicCatChild"></span>
              </div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">注意事項：</div>
            </div>
            <div id="basicWarning" style="font-size:10px;">
              <!-- タグをここに -->
            </div>
          </div>
        </div>

        <!-- 中央 -->
        <div class="summary-center">
          <div class="center-title">利益・販売予測</div>
          <div class="center-row">
            <div class="center-row-label">FBA最安値</div>
            <div id="centerFBA" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">過去3月FBA最安値</div>
            <div id="centerFBA3m" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">利益率</div>
            <div id="centerMargin" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">利益額（円）</div>
            <div id="centerProfit" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">予測30日販売数</div>
            <div id="centerForecast30" class="center-row-value"></div>
          </div>
        </div>

        <!-- 右：グラフ -->
        <div class="summary-right">
          <div class="graph-header">
            <div class="graph-header-title">グラフ（180日）</div>
            <div class="graph-options">
              <label>
                <input type="checkbox" id="chkDemandSupply" checked>
                《需要＆供給》
              </label>
              <label>
                <input type="checkbox" id="chkSupplyPrice">
                《供給＆価格》
              </label>
            </div>
          </div>
          <div class="graph-body">
            <div class="graph-canvas-wrap">
              <canvas id="mainChart"></canvas>
            </div>
            <div class="graph-caption">ランキング / セラー数 / 価格（USD）。チェックボックスで表示線を切り替え。</div>
          </div>
        </div>
      </div>

      <!-- ASIN未選択時 -->
      <div id="placeholder" class="detail-card">
        <div class="detail-title">ASINを入力してください</div>
        <div class="placeholder">
          上部の ASIN 入力欄に、登録済み ASIN（下の青いラベル）を入力して「表示」を押すと、ここに詳細が表示されます。
        </div>
      </div>

      <!-- 下段：その他の指標（テーブル） -->
      <div id="detailCard" class="detail-table-wrapper" style="display:none;">
        <div class="detail-table-container">
          <div class="detail-table-header-bar">
            <span>その他の指標</span>
            <small>ヘッダーをドラッグで並び替え、「−」で列を非表示にできます。</small>
          </div>
          <div id="detailHiddenBar" class="detail-hidden-bar"></div>
          <div class="detail-table-scroll">
            <table id="detailTable" class="detail-table">
              <thead>
                <tr id="detailHeaderRow"></tr>
              </thead>
              <tbody>
                <tr id="detailBodyRow"></tr>
              </tbody>
            </table>
          </div>
          <div class="detail-table-footer">
            横スクロールで全項目を確認できます。非表示にした列は上部のバーから「＋」で再表示できます。
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- === ASINデータ === -->
<script src="asin-data.js"></script>

<script>
  /* ========= 共通要素 ========= */
  const asinInput = document.getElementById("asinInput");
  const loadBtn = document.getElementById("loadBtn");
  const headerStatus = document.getElementById("headerStatus");
  const asinCatalog = document.getElementById("asinCatalog");

  const summaryCard = document.getElementById("summaryCard");
  const placeholderCard = document.getElementById("placeholder");
  const detailCard = document.getElementById("detailCard");

  const prodImage = document.getElementById("prodImage");
  const basicTitle = document.getElementById("basicTitle");
  const basicBrand = document.getElementById("basicBrand");
  const basicRating = document.getElementById("basicRating");
  const basicASIN = document.getElementById("basicASIN");
  const basicCatParent = document.getElementById("basicCatParent");
  const basicCatChild = document.getElementById("basicCatChild");
  const basicWarning = document.getElementById("basicWarning");

  const centerFBA = document.getElementById("centerFBA");
  const centerFBA3m = document.getElementById("centerFBA3m");
  const centerMargin = document.getElementById("centerMargin");
  const centerProfit = document.getElementById("centerProfit");
  const centerForecast30 = document.getElementById("centerForecast30");

  const chkDemandSupply = document.getElementById("chkDemandSupply");
  const chkSupplyPrice = document.getElementById("chkSupplyPrice");
  const mainChartCanvas = document.getElementById("mainChart");

  let mainChartInstance = null;

  /* ========= 需給グラフ用疑似データ ========= */
  function createPRNG(seedStr) {
    let seed = 0;
    for (let i = 0; i < seedStr.length; i++) seed += seedStr.charCodeAt(i);
    return function () {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };
  }

  function getDemandSupplySeries(asin) {
    const rand = createPRNG(asin);
    const days = 180;
    const labels = [];
    const ranking = [];
    const sellers = [];
    const price = [];
    let rank = 60000 * (0.6 + rand() * 0.4);
    let seller = 5 + Math.round(rand() * 5);
    let p = 25 + rand() * 30;

    for (let i = days - 1; i >= 0; i--) {
      labels.push(`${i}日前`);
      rank += (rand() - 0.5) * 4000;
      rank = Math.max(5000, Math.min(80000, rank));
      seller += (rand() - 0.5) * 2;
      seller = Math.max(1, Math.min(25, seller));
      p += (rand() - 0.5) * 2;
      p = Math.max(10, Math.min(80, p));
      ranking.push(Math.round(rank));
      sellers.push(Number(seller.toFixed(1)));
      price.push(Number(p.toFixed(2)));
    }
    labels.reverse(); ranking.reverse(); sellers.reverse(); price.reverse();
    return { labels, ranking, sellers, price };
  }

  /* ========= グラフ描画 ========= */
  function updateChartVisibility() {
    if (!mainChartInstance) return;
    const demandOn = chkDemandSupply.checked;
    const supplyPriceOn = chkSupplyPrice.checked;

    let showRank = true, showSeller = true, showPrice = true;

    if (demandOn && !supplyPriceOn) {
      showRank = true; showSeller = true; showPrice = false;
    } else if (!demandOn && supplyPriceOn) {
      showRank = false; showSeller = true; showPrice = true;
    } else if (demandOn && supplyPriceOn) {
      showRank = true; showSeller = true; showPrice = true;
    } else {
      showRank = true; showSeller = true; showPrice = true;
    }

    mainChartInstance.data.datasets[0].hidden = !showRank;
    mainChartInstance.data.datasets[1].hidden = !showSeller;
    mainChartInstance.data.datasets[2].hidden = !showPrice;
    mainChartInstance.update();
  }

  function renderChart(asin) {
    const series = getDemandSupplySeries(asin);

    if (mainChartInstance) {
      mainChartInstance.destroy();
      mainChartInstance = null;
    }
    const ctx = mainChartCanvas.getContext("2d");
    mainChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: series.labels,
        datasets: [
          { label: "ランキング（小さいほど上位）", data: series.ranking, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: series.sellers, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格（USD）", data: series.price, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label || "";
                if (ctx.dataset.yAxisID === "yPrice") {
                  return `${label}: $${ctx.parsed.y.toFixed(2)}`;
                }
                return `${label}: ${ctx.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: { display: true, ticks: { maxTicksLimit: 10 } },
          yRank: { type: "linear", position: "left", reverse: true, title: { display: true, text: "ランキング" } },
          ySeller: { type: "linear", position: "right", title: { display: true, text: "セラー数" }, grid: { drawOnChartArea: false } },
          yPrice: { type: "linear", position: "right", offset: true, title: { display: true, text: "価格(USD)" }, grid: { drawOnChartArea: false } }
        }
      }
    });

    chkDemandSupply.checked = true;
    chkSupplyPrice.checked = false;
    updateChartVisibility();
  }

  chkDemandSupply.addEventListener("change", updateChartVisibility);
  chkSupplyPrice.addEventListener("change", updateChartVisibility);

  /* ========= 注意事項タグ ========= */
  function renderWarningTags(container, rawText) {
    container.innerHTML = "";
    const text = (rawText || "").trim();
    if (!text) {
      container.textContent = "－";
      return;
    }

    const tags = [];
    const pushIfIncluded = (keyword, className) => {
      if (text.includes(keyword)) {
        tags.push({ label: keyword, cls: className });
      }
    };

    pushIfIncluded("輸出不可", "warning-export-ban");
    pushIfIncluded("知財",     "warning-ip");
    pushIfIncluded("大型",     "warning-large");
    pushIfIncluded("出荷禁止", "warning-ship-ban");
    pushIfIncluded("承認要",   "warning-approval");
    pushIfIncluded("バリエーション", "warning-variation");

    const wrap = document.createElement("div");
    wrap.className = "warning-tags";

    if (!tags.length) {
      // キーワードに当てはまらない場合は1つのタグとして表示
      const span = document.createElement("span");
      span.className = "warning-tag warning-plain";
      span.textContent = text;
      wrap.appendChild(span);
    } else {
      tags.forEach(t => {
        const span = document.createElement("span");
        span.className = "warning-tag " + t.cls;
        span.textContent = t.label;
        wrap.appendChild(span);
      });
    }
    container.appendChild(wrap);
  }

  /* ========= その他の指標テーブル ========= */
  const detailTable = document.getElementById("detailTable");
  const detailHeaderRow = document.getElementById("detailHeaderRow");
  const detailBodyRow   = document.getElementById("detailBodyRow");
  const detailHiddenBar = document.getElementById("detailHiddenBar");

  const DETAIL_COLUMNS_DEF = [
    { id: "アメリカASIN", label: "アメリカASIN", visible:true },
    { id: "日本ASIN",     label: "日本ASIN",     visible:true },
    { id: "JAN",          label: "JAN",          visible:true },
    { id: "SKU",          label: "SKU",          visible:true },
    { id: "個数",         label: "個数",         visible:true },
    { id: "30日販売数",   label: "30日販売数",   visible:true },
    { id: "90日販売数",   label: "90日販売数",   visible:false },
    { id: "180日販売数",  label: "180日販売数",  visible:false },
    { id: "複数在庫指数45日分", label: "複数在庫指数45日分", visible:false },
    { id: "複数在庫指数60日分", label: "複数在庫指数60日分", visible:false },
    { id: "ライバル偏差1", label: "ライバル偏差×1", visible:false },
    { id: "ライバル偏差2", label: "ライバル偏差×2", visible:false },
    { id: "ライバル増加率", label: "ライバル増加率", visible:false },
    { id: "在庫数",       label: "在庫数",       visible:true },
    { id: "返品率",       label: "返品率",       visible:true },
    { id: "販売額（ドル）", label:"販売額（ドル）", visible:true },
    { id: "入金額（円）",  label:"入金額（円）",  visible:true },
    { id: "入金額計（円）", label:"入金額計（円）", visible:false },
    { id: "粗利益率予測", label:"粗利益率予測", visible:true },
    { id: "粗利益予測",   label:"粗利益予測",   visible:true },
    { id: "粗利益",       label:"粗利益",       visible:false },
    { id: "仕入れ目安単価", label:"仕入れ目安単価", visible:true },
    { id: "仕入合計",     label:"仕入合計",     visible:false },
    { id: "仕入計",       label:"仕入計",       visible:false },
    { id: "重量kg",       label:"重量（kg）",   visible:true },
    { id: "サイズ",       label:"サイズ（縦×横×高さ）", visible:true },
    { id: "サイズ感",     label:"サイズ感",     visible:false },
    { id: "容積重量",     label:"容積重量",     visible:false },
    { id: "材質",         label:"材質",         visible:true },
    { id: "大型",         label:"大型判定",     visible:true },
    { id: "請求重量",     label:"請求重量",     visible:false },
    { id: "想定送料",     label:"想定送料",     visible:true },
    { id: "送料",         label:"送料",         visible:false },
    { id: "関税",         label:"関税",         visible:true },
    { id: "Keepaリンク",  label:"Keepa (US)",   visible:true }
  ];

  let detailColumns = DETAIL_COLUMNS_DEF.map(c => ({...c}));
  let detailDragId = null;

  function detailVisibleCols() {
    return detailColumns.filter(c => c.visible !== false);
  }

  function buildDetailHeader() {
    detailHeaderRow.innerHTML = "";
    detailVisibleCols().forEach(col => {
      const th = document.createElement("th");
      th.dataset.colId = col.id;
      th.draggable = true;

      const inner = document.createElement("div");
      inner.className = "th-inner";

      const labelSpan = document.createElement("span");
      labelSpan.className = "th-label";
      labelSpan.textContent = col.label;
      inner.appendChild(labelSpan);

      const toggleBtn = document.createElement("button");
      toggleBtn.className = "th-toggle";
      toggleBtn.textContent = "−";
      toggleBtn.title = "この列を非表示にする";
      toggleBtn.addEventListener("click", (e)=> {
        e.stopPropagation();
        col.visible = false;
        rebuildDetailTable(lastDetailData);
      });
      inner.appendChild(toggleBtn);

      th.appendChild(inner);
      detailHeaderRow.appendChild(th);

      th.addEventListener("dragstart", e => {
        detailDragId = col.id;
        e.dataTransfer.effectAllowed = "move";
      });
      th.addEventListener("dragover", e => {
        e.preventDefault();
        th.classList.add("drag-over");
        e.dataTransfer.dropEffect = "move";
      });
      th.addEventListener("dragleave", ()=> th.classList.remove("drag-over"));
      th.addEventListener("drop", e => {
        e.preventDefault();
        th.classList.remove("drag-over");
        const targetId = col.id;
        if (!detailDragId || detailDragId === targetId) return;
        const srcIndex = detailColumns.findIndex(c=>c.id===detailDragId);
        const dstIndex = detailColumns.findIndex(c=>c.id===targetId);
        if (srcIndex === -1 || dstIndex === -1) return;
        const [moved] = detailColumns.splice(srcIndex,1);
        detailColumns.splice(dstIndex,0,moved);
        detailDragId = null;
        rebuildDetailTable(lastDetailData);
      });
    });
  }

  function renderDetailHiddenBar() {
    const hidden = detailColumns.filter(c => !c.visible);
    detailHiddenBar.innerHTML = "";
    if (!hidden.length) {
      detailHiddenBar.style.display = "none";
      return;
    }
    detailHiddenBar.style.display = "flex";
    hidden.forEach(col => {
      const pill = document.createElement("div");
      pill.className = "detail-hidden-pill";
      pill.innerHTML = `<span>${col.label}</span>`;
      const btn = document.createElement("button");
      btn.textContent = "＋";
      btn.title = "この列を再表示";
      btn.addEventListener("click", ()=> {
        col.visible = true;
        rebuildDetailTable(lastDetailData);
      });
      pill.appendChild(btn);
      detailHiddenBar.appendChild(pill);
    });
  }

  let lastDetailData = null;

  function fillDetailRow(data) {
    detailBodyRow.innerHTML = "";
    if (!data) return;
    detailVisibleCols().forEach(col => {
      const td = document.createElement("td");
      td.dataset.colId = col.id;
      const value = data[col.id];

      if (col.id === "Keepaリンク" && value) {
        const a = document.createElement("a");
        a.href = value;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "グラフを開く";
        td.appendChild(a);
      } else {
        td.textContent = value === undefined || value === "" ? "－" : value;
      }
      detailBodyRow.appendChild(td);
    });
  }

  function rebuildDetailTable(data) {
    lastDetailData = data;
    buildDetailHeader();
    fillDetailRow(data);
    renderDetailHiddenBar();
  }

  /* ========= 詳細描画 ========= */
  function renderDetail(asin, data) {
    // 上段
    prodImage.src = data["商品画像"] || "";
    prodImage.alt = data["品名"] || asin;
    basicTitle.textContent = data["品名"] || "";
    basicBrand.textContent = data["ブランド"] || "";
    basicRating.textContent = data["レビュー評価"] || "";
    basicASIN.textContent = asin;
    basicCatParent.textContent = data["親カテゴリ"] || "";
    basicCatChild.textContent = data["サブカテゴリ"] || "";
    renderWarningTags(basicWarning, data["注意事項（警告系）"]);

    centerFBA.textContent = data["FBA最安値"] || "－";
    centerFBA3m.textContent = data["過去3月FBA最安値"] || "－";
    centerMargin.textContent = data["粗利益率予測"] || "－";
    centerProfit.textContent = data["粗利益予測"] || data["粗利益"] || "－";
    centerForecast30.textContent = data["予測30日販売数"] || "－";

    summaryCard.style.display = "grid";
    placeholderCard.style.display = "none";

    // 下段テーブル
    rebuildDetailTable(data);
    detailCard.style.display = "block";

    renderChart(asin);
  }

  function clearViewWithMessage(msg) {
    summaryCard.style.display = "none";
    detailCard.style.display = "none";
    placeholderCard.style.display = "block";
    if (msg) {
      placeholderCard.querySelector(".placeholder").textContent = msg;
    }
  }

  function loadAsin() {
    const asin = asinInput.value.trim().toUpperCase();
    if (!asin) {
      clearViewWithMessage("ASINを入力してください。");
      return;
    }
    const data = ASIN_DATA[asin];
    if (!data) {
      clearViewWithMessage(`ASIN「${asin}」のデータがありません。下の一覧から登録済みASINを確認してください。`);
      return;
    }
    renderDetail(asin, data);
  }

  loadBtn.addEventListener("click", loadAsin);
  asinInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      loadAsin();
    }
  });

  /* ========= ASIN一覧表示 ========= */
  function initCatalog() {
    const asins = Object.keys(ASIN_DATA || {});
    headerStatus.textContent = `登録ASIN数：${asins.length}件`;
    asinCatalog.innerHTML = "";
    if (!asins.length) return;
    const label = document.createElement("span");
    label.className = "asin-catalog-label";
    label.textContent = "データがあるASIN：";
    asinCatalog.appendChild(label);
    asins.forEach(a => {
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = a;
      pill.style.cursor = "pointer";
      pill.addEventListener("click", () => {
        asinInput.value = a;
        loadAsin();
      });
      asinCatalog.appendChild(pill);
    });
  }

  /* ========= 初期化 ========= */
  initCatalog();
  buildDetailHeader(); // 初期構築（空データ）
  renderDetailHiddenBar();
</script>
</body>
</html>

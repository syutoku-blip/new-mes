<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MES-AI-A 詳細ビュー</title>

  <!-- Chart.js（グラフ用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --bg-header: #4b6bff;
      --bg-header2: #eef1fb;
      --border: #d4d8ea;
      --accent: #4b6bff;
      --text-main: #111827;
      --text-muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }
    .app-shell { min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 14px 24px;
      background: linear-gradient(90deg, #4b6bff, #8a63ff);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 2px 10px rgba(15,23,42,.18);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: .03em;
    }
    header .subtitle {
      font-size: 12px;
      opacity: 0.9;
    }
    .status {
      font-size: 12px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar {
      padding: 10px 24px 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .toolbar label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .toolbar input[type="text"] {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      min-width: 140px;
    }
    .toolbar button {
      border-radius: 999px;
      border: none;
      font-size: 12px;
      padding: 6px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform .06s ease-out, box-shadow .06s ease-out;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 6px rgba(75,107,255,0.35);
    }
    .toolbar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(75,107,255,0.45);
    }

    .asin-catalog {
      padding: 0 24px 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .asin-catalog-label {
      margin-right: 4px;
      font-weight: 600;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 7px;
      border-radius: 999px;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 10px;
      font-weight: 600;
    }
    .pill-ok { background: #dcfce7; color: #15803d; }
    .pill-danger { background: #fee2e2; color: #b91c1c; }

    .page-body {
      flex: 1;
      padding: 10px 20px 24px;
      display: flex;
      justify-content: center;
    }
    .content {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* ====== 上段：1枠（画像のイメージ） ====== */
    .summary-card {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(15,23,42,.12);
      padding: 12px 14px;
      display: grid;
      grid-template-columns: minmax(260px, 1.1fr) minmax(200px,.8fr) minmax(320px,1.1fr);
      gap: 10px;
      min-height: 210px;
    }

    /* 左: 画像＋基本情報 */
    .summary-left {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 8px;
      align-items: start;
    }
    .summary-image-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .summary-image-box img {
      max-width: 90px;
      max-height: 110px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      object-fit: contain;
      background: #f9fafb;
    }
    .qty-row {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
    }
    .qty-row select {
      font-size: 10px;
      padding: 1px 4px;
    }
    .summary-basic {
      font-size: 11px;
    }
    .summary-basic-row {
      margin-bottom: 3px;
      display: flex;
      gap: 4px;
    }
    .summary-basic-label {
      min-width: 52px;
      color: var(--text-muted);
    }
    .summary-basic-value {
      font-weight: 500;
    }
    .summary-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    /* 中央: 価格＆利益 */
    .summary-center {
      background: #fefce8;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 11px;
      border: 1px solid #facc15;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .center-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .center-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .center-row-label {
      color: var(--text-muted);
    }
    .center-row-value {
      font-weight: 600;
    }

    /* 右: グラフ箱 */
    .summary-right {
      background: #eff6ff;
      border-radius: 8px;
      padding: 6px 8px 8px;
      border: 1px solid #bfdbfe;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .graph-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }
    .graph-header-title {
      font-weight: 600;
      color: #1d4ed8;
    }
    .graph-options {
      font-size: 10px;
    }
    .graph-options label {
      display: block;
      cursor: pointer;
    }
    .graph-options input {
      width: 11px;
      height: 11px;
    }
    .graph-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .graph-canvas-wrap {
      flex: 1;
      min-height: 130px;
    }
    .graph-caption {
      font-size: 9px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 1px;
    }

    /* ====== 下段：その他の項目 ====== */
    .detail-card {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(15,23,42,.08);
      padding: 10px 14px 12px;
    }
    .detail-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      border-left: 3px solid var(--accent);
      padding-left: 8px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(190px,1fr));
      gap: 6px 16px;
      font-size: 11px;
    }
    .detail-item-label {
      color: var(--text-muted);
      margin-bottom: 1px;
    }
    .detail-item-value {
      font-weight: 500;
      word-break: break-all;
    }
    .detail-item a {
      text-decoration: none;
      color: #4338ca;
      font-weight: 600;
      font-size: 11px;
    }

    .placeholder {
      padding: 12px 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      .summary-card {
        grid-template-columns: 1fr;
      }
      .summary-right {
        min-height: 190px;
      }
    }
    @media (max-width: 600px) {
      header { flex-direction: column; align-items: flex-start; }
      .toolbar { padding-inline: 16px; }
      .page-body { padding-inline: 10px; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div>
      <h1>MES-AI-A ASIN 詳細ビュー（2ページ目）</h1>
      <div class="subtitle">ASINを入力すると、上段1枠に基本情報＋利益＋180日グラフ、下段にその他の指標が表示されます。</div>
    </div>
    <div id="headerStatus" class="status"></div>
  </header>

  <div class="toolbar">
    <label for="asinInput">ASIN:</label>
    <input id="asinInput" type="text" placeholder="例）B0A0000001" />
    <button id="loadBtn">表示</button>
  </div>

  <!-- 登録済みASIN一覧 -->
  <div class="asin-catalog" id="asinCatalog"></div>

  <div class="page-body">
    <div class="content">
      <!-- 上段：1枠 -->
      <div id="summaryCard" class="summary-card" style="display:none;">
        <!-- 左 -->
        <div class="summary-left">
          <div class="summary-image-box">
            <img id="prodImage" src="" alt="商品画像" />
            <div class="qty-row">
              <span>数量</span>
              <select id="qtySelect">
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>
          <div class="summary-basic">
            <div id="basicTitle" class="summary-title"></div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">ブランド：</div>
              <div id="basicBrand" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">評価：</div>
              <div id="basicRating" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">ASIN：</div>
              <div id="basicASIN" class="summary-basic-value"></div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">カテゴリ：</div>
              <div class="summary-basic-value">
                <span id="basicCatParent"></span>
                <span> / </span>
                <span id="basicCatChild"></span>
              </div>
            </div>
            <div class="summary-basic-row">
              <div class="summary-basic-label">注意事項：</div>
            </div>
            <div style="font-size:10px;color:#b91c1c;" id="basicWarning"></div>
          </div>
        </div>

        <!-- 中央 -->
        <div class="summary-center">
          <div class="center-title">利益・販売予測</div>
          <div class="center-row">
            <div class="center-row-label">FBA最安値</div>
            <div id="centerFBA" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">過去3月FBA最安値</div>
            <div id="centerFBA3m" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">利益率</div>
            <div id="centerMargin" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">利益額（円）</div>
            <div id="centerProfit" class="center-row-value"></div>
          </div>
          <div class="center-row">
            <div class="center-row-label">予測30日販売数</div>
            <div id="centerForecast30" class="center-row-value"></div>
          </div>
        </div>

        <!-- 右：グラフ -->
        <div class="summary-right">
          <div class="graph-header">
            <div class="graph-header-title">グラフ（180日）</div>
            <div class="graph-options">
              <label>
                <input type="checkbox" id="chkDemandSupply" checked>
                《需要＆供給》
              </label>
              <label>
                <input type="checkbox" id="chkSupplyPrice">
                《供給＆価格》
              </label>
            </div>
          </div>
          <div class="graph-body">
            <div class="graph-canvas-wrap">
              <canvas id="mainChart"></canvas>
            </div>
            <div class="graph-caption">ランキング / セラー数 / 価格（USD）。チェックボックスで表示線を切り替え。</div>
          </div>
        </div>
      </div>

      <!-- ASIN未選択時 -->
      <div id="placeholder" class="detail-card">
        <div class="detail-title">ASINを入力してください</div>
        <div class="placeholder">
          上部の ASIN 入力欄に、登録済み ASIN（下の青いラベル）を入力して「表示」を押すと、ここに詳細が表示されます。
        </div>
      </div>

      <!-- 下段：その他の項目 -->
      <div id="detailCard" class="detail-card" style="display:none;">
        <div class="detail-title">その他の指標</div>
        <div id="detailGrid" class="detail-grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- === ASINデータ === -->
<script src="asin-data.js"></script>

<script>
  /* ========= ユーティリティ ========= */
  const asinInput = document.getElementById("asinInput");
  const loadBtn = document.getElementById("loadBtn");
  const headerStatus = document.getElementById("headerStatus");
  const asinCatalog = document.getElementById("asinCatalog");

  const summaryCard = document.getElementById("summaryCard");
  const placeholderCard = document.getElementById("placeholder");
  const detailCard = document.getElementById("detailCard");
  const detailGrid = document.getElementById("detailGrid");

  const prodImage = document.getElementById("prodImage");
  const basicTitle = document.getElementById("basicTitle");
  const basicBrand = document.getElementById("basicBrand");
  const basicRating = document.getElementById("basicRating");
  const basicASIN = document.getElementById("basicASIN");
  const basicCatParent = document.getElementById("basicCatParent");
  const basicCatChild = document.getElementById("basicCatChild");
  const basicWarning = document.getElementById("basicWarning");

  const centerFBA = document.getElementById("centerFBA");
  const centerFBA3m = document.getElementById("centerFBA3m");
  const centerMargin = document.getElementById("centerMargin");
  const centerProfit = document.getElementById("centerProfit");
  const centerForecast30 = document.getElementById("centerForecast30");

  const chkDemandSupply = document.getElementById("chkDemandSupply");
  const chkSupplyPrice = document.getElementById("chkSupplyPrice");
  const mainChartCanvas = document.getElementById("mainChart");

  let mainChartInstance = null;

  function createPRNG(seedStr) {
    let seed = 0;
    for (let i = 0; i < seedStr.length; i++) seed += seedStr.charCodeAt(i);
    return function () {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };
  }

  function getDemandSupplySeries(asin) {
    const rand = createPRNG(asin);
    const days = 180;
    const labels = [];
    const ranking = [];
    const sellers = [];
    const price = [];
    let rank = 60000 * (0.6 + rand() * 0.4);
    let seller = 5 + Math.round(rand() * 5);
    let p = 25 + rand() * 30;

    for (let i = days - 1; i >= 0; i--) {
      labels.push(`${i}日前`);
      rank += (rand() - 0.5) * 4000;
      rank = Math.max(5000, Math.min(80000, rank));
      seller += (rand() - 0.5) * 2;
      seller = Math.max(1, Math.min(25, seller));
      p += (rand() - 0.5) * 2;
      p = Math.max(10, Math.min(80, p));
      ranking.push(Math.round(rank));
      sellers.push(Number(seller.toFixed(1)));
      price.push(Number(p.toFixed(2)));
    }
    labels.reverse(); ranking.reverse(); sellers.reverse(); price.reverse();
    return { labels, ranking, sellers, price };
  }

  /* ========= グラフ ========= */
  function updateChartVisibility() {
    if (!mainChartInstance) return;
    const demandOn = chkDemandSupply.checked;
    const supplyPriceOn = chkSupplyPrice.checked;

    let showRank = true, showSeller = true, showPrice = true;

    if (demandOn && !supplyPriceOn) {
      // 需要＆供給
      showRank = true; showSeller = true; showPrice = false;
    } else if (!demandOn && supplyPriceOn) {
      // 供給＆価格
      showRank = false; showSeller = true; showPrice = true;
    } else if (demandOn && supplyPriceOn) {
      showRank = true; showSeller = true; showPrice = true;
    } else {
      // どちらもOFF → 全表示
      showRank = true; showSeller = true; showPrice = true;
    }

    mainChartInstance.data.datasets[0].hidden = !showRank;
    mainChartInstance.data.datasets[1].hidden = !showSeller;
    mainChartInstance.data.datasets[2].hidden = !showPrice;
    mainChartInstance.update();
  }

  function renderChart(asin) {
    const series = getDemandSupplySeries(asin);

    if (mainChartInstance) {
      mainChartInstance.destroy();
      mainChartInstance = null;
    }
    const ctx = mainChartCanvas.getContext("2d");
    mainChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: series.labels,
        datasets: [
          { label: "ランキング（小さいほど上位）", data: series.ranking, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: series.sellers, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格（USD）", data: series.price, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label || "";
                if (ctx.dataset.yAxisID === "yPrice") {
                  return `${label}: $${ctx.parsed.y.toFixed(2)}`;
                }
                return `${label}: ${ctx.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: { display: true, ticks: { maxTicksLimit: 10 } },
          yRank: { type: "linear", position: "left", reverse: true, title: { display: true, text: "ランキング" } },
          ySeller: { type: "linear", position: "right", title: { display: true, text: "セラー数" }, grid: { drawOnChartArea: false } },
          yPrice: { type: "linear", position: "right", offset: true, title: { display: true, text: "価格(USD)" }, grid: { drawOnChartArea: false } }
        }
      }
    });

    // デフォルトは《需要＆供給》のみON
    chkDemandSupply.checked = true;
    chkSupplyPrice.checked = false;
    updateChartVisibility();
  }

  chkDemandSupply.addEventListener("change", updateChartVisibility);
  chkSupplyPrice.addEventListener("change", updateChartVisibility);

  /* ========= 詳細描画 ========= */
  const DETAIL_FIELDS = [
    { key: "アメリカASIN", label: "アメリカASIN" },
    { key: "日本ASIN", label: "日本ASIN" },
    { key: "JAN", label: "JAN" },
    { key: "SKU", label: "SKU" },
    { key: "個数", label: "個数" },
    { key: "30日販売数", label: "30日販売数" },
    { key: "90日販売数", label: "90日販売数" },
    { key: "180日販売数", label: "180日販売数" },
    { key: "複数在庫指数45日分", label: "複数在庫指数 45日分" },
    { key: "複数在庫指数60日分", label: "複数在庫指数 60日分" },
    { key: "ライバル偏差1", label: "ライバル偏差 ×1" },
    { key: "ライバル偏差2", label: "ライバル偏差 ×2" },
    { key: "ライバル増加率", label: "ライバル増加率" },
    { key: "在庫数", label: "在庫数" },
    { key: "FBA出品", label: "FBA出品" },
    { key: "返品率", label: "返品率" },
    { key: "カートボックス価格", label: "カートボックス価格" },
    { key: "販売額（ドル）", label: "販売額（ドル）" },
    { key: "入金額（円）", label: "入金額（円）" },
    { key: "入金額計（円）", label: "入金額計（円）" },
    { key: "粗利益率予測", label: "粗利益率予測" },
    { key: "粗利益予測", label: "粗利益予測" },
    { key: "粗利益", label: "粗利益" },
    { key: "仕入れ目安単価", label: "仕入れ目安単価" },
    { key: "仕入合計", label: "仕入合計" },
    { key: "仕入計", label: "仕入計" },
    { key: "重量kg", label: "重量（kg）" },
    { key: "サイズ", label: "サイズ（縦×横×高さ）" },
    { key: "サイズ感", label: "サイズ感" },
    { key: "容積重量", label: "容積重量" },
    { key: "材質", label: "材質" },
    { key: "大型", label: "大型判定" },
    { key: "請求重量", label: "請求重量" },
    { key: "想定送料", label: "想定送料" },
    { key: "送料", label: "送料" },
    { key: "関税", label: "関税" }
  ];

  function renderDetail(asin, data) {
    // 上段
    prodImage.src = data["商品画像"] || "";
    prodImage.alt = data["品名"] || asin;
    basicTitle.textContent = data["品名"] || "";
    basicBrand.textContent = data["ブランド"] || "";
    basicRating.textContent = data["レビュー評価"] || "";
    basicASIN.textContent = asin;
    basicCatParent.textContent = data["親カテゴリ"] || "";
    basicCatChild.textContent = data["サブカテゴリ"] || "";
    basicWarning.textContent = data["注意事項（警告系）"] || "－";

    centerFBA.textContent = data["FBA最安値"] || "－";
    centerFBA3m.textContent = data["過去3月FBA最安値"] || "－";
    centerMargin.textContent = data["粗利益率予測"] || "－";
    centerProfit.textContent = data["粗利益予測"] || data["粗利益"] || "－";
    centerForecast30.textContent = data["予測30日販売数"] || "－";

    summaryCard.style.display = "grid";
    placeholderCard.style.display = "none";

    // 下段その他
    detailGrid.innerHTML = "";
    DETAIL_FIELDS.forEach(field => {
      const v = data[field.key];
      if (v === undefined || v === "") return;
      const item = document.createElement("div");
      item.className = "detail-item";
      const label = document.createElement("div");
      label.className = "detail-item-label";
      label.textContent = field.label;
      const value = document.createElement("div");
      value.className = "detail-item-value";
      value.textContent = v;
      item.appendChild(label);
      item.appendChild(value);
      detailGrid.appendChild(item);
    });

    // Keepaリンクだけ別扱い
    if (data["Keepaリンク"]) {
      const item = document.createElement("div");
      item.className = "detail-item";
      const label = document.createElement("div");
      label.className = "detail-item-label";
      label.textContent = "Keepa (アメリカAmazon)";
      const value = document.createElement("div");
      value.className = "detail-item-value";
      const a = document.createElement("a");
      a.href = data["Keepaリンク"];
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = "グラフを開く";
      value.appendChild(a);
      item.appendChild(label);
      item.appendChild(value);
      detailGrid.appendChild(item);
    }

    detailCard.style.display = "block";

    renderChart(asin);
  }

  function clearViewWithMessage(msg) {
    summaryCard.style.display = "none";
    detailCard.style.display = "none";
    placeholderCard.style.display = "block";
    if (msg) {
      placeholderCard.querySelector(".placeholder").textContent = msg;
    }
  }

  function loadAsin() {
    const asin = asinInput.value.trim().toUpperCase();
    if (!asin) {
      clearViewWithMessage("ASINを入力してください。");
      return;
    }
    const data = ASIN_DATA[asin];
    if (!data) {
      clearViewWithMessage(`ASIN「${asin}」のデータがありません。下の一覧から登録済みASINを確認してください。`);
      return;
    }
    renderDetail(asin, data);
  }

  loadBtn.addEventListener("click", loadAsin);
  asinInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      loadAsin();
    }
  });

  /* ========= ASIN一覧表示 ========= */
  function initCatalog() {
    const asins = Object.keys(ASIN_DATA || {});
    headerStatus.textContent = `登録ASIN数：${asins.length}件`;
    asinCatalog.innerHTML = "";
    if (!asins.length) return;
    const label = document.createElement("span");
    label.className = "asin-catalog-label";
    label.textContent = "データがあるASIN：";
    asinCatalog.appendChild(label);
    asins.forEach(a => {
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = a;
      pill.style.cursor = "pointer";
      pill.addEventListener("click", () => {
        asinInput.value = a;
        loadAsin();
      });
      asinCatalog.appendChild(pill);
    });
  }

  /* ========= 初期化 ========= */
  initCatalog();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MES-AI-A ASINダッシュボード</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-header: #ffffff;
      --bg-header2: #eef1fb;
      --bg-row-alt: #fafbff;
      --border: #d4d8ea;
      --accent: #4b6bff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }
    .app-shell { min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 14px 24px;
      background: linear-gradient(90deg, #4b6bff, #8a63ff);
      color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: .03em;
    }
    header .subtitle {
      font-size: 12px;
      opacity: 0.9;
    }

    .nav-switch-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .nav-tab-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.15);
      font-size: 12px;
      padding: 5px 12px;
      cursor: pointer;
      color: #e5e7ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(6px);
      transition: background 0.12s, color 0.12s, transform 0.06s;
    }
    .nav-tab-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    .nav-tab-btn.active {
      background: #ffffff;
      color: #4b6bff;
      border-color: #ffffff;
    }

    .toolbar {
      padding: 8px 24px 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .toolbar label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .toolbar input[type="text"] {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      min-width: 140px;
      font-size: 12px;
    }
    .toolbar button {
      border-radius: 999px;
      border: none;
      font-size: 12px;
      padding: 5px 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.04s ease-out, box-shadow 0.04s ease-out, background 0.1s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 6px rgba(75,107,255,0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(75,107,255,0.45);
    }
    .btn-ghost {
      background: #ffffff;
      color: var(--text-main);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: #f3f4ff; }

    .status {
      margin-left: auto;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .asin-catalog {
      padding: 0 24px 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .asin-catalog-label {
      margin-right: 4px;
      font-weight: 600;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 7px;
      border-radius: 999px;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 10px;
      font-weight: 600;
    }
    .pill-danger { background: #fee2e2; color: #b91c1c; }
    .pill-ok { background: #dcfce7; color: #15803d; }

    .hidden-cols-bar {
      padding: 0 24px 6px;
      display: none;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .hidden-col-pill {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 7px;
      border-radius: 999px;
      background: #f3f4ff;
      border: 1px dashed #c7d2fe;
    }
    .hidden-col-pill button {
      border: none;
      background: transparent;
      font-size: 11px;
      cursor: pointer;
      color: #4f46e5;
    }

    .table-wrapper { flex: 1; padding: 8px 16px 24px; }
    .table-container {
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(15,23,42,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }
    .table-scroll { overflow-x: auto; overflow-y: hidden; }

    table {
      border-collapse: separate;
      border-spacing: 0;
      min-width: 2200px;
      font-size: 10px;
      line-height: 1.3;
    }
    thead { background: linear-gradient(180deg, var(--bg-header), var(--bg-header2)); }

    th, td {
      padding: 3px 4px;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      max-width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: center;
    }
    th {
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 600;
      color: var(--text-muted);
      background: linear-gradient(180deg, var(--bg-header), var(--bg-header2));
      cursor: grab;
      user-select: none;
    }
    th.drag-over {
      outline: 2px dashed #c7d2fe;
      background: #e5e7ff;
    }
    th .th-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    th .th-label {
      font-size: 10px;
    }
    th .th-toggle {
      border: none;
      background: transparent;
      font-size: 11px;
      cursor: pointer;
      color: #9ca3af;
      padding: 0 2px;
    }
    th .th-toggle:hover {
      color: #ef4444;
    }

    th:nth-child(1),
    td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #f4f5ff;
      box-shadow: 4px 0 6px rgba(15,23,42,0.05);
    }

    tr:nth-child(even) td { background: var(--bg-row-alt); }
    tbody tr:hover td { background: #f1f5ff; }

    td img.product-image {
      max-height: 48px;
      border-radius: 6px;
      display: block;
      margin: 0 auto;
    }
    td.input-cell input.asin-input {
      width: 100%;
      padding: 2px 4px;
      font-size: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    td.readonly-cell { font-size: 10px; }

    td.multi-line {
      white-space: normal;
      text-align: left;
      line-height: 1.25;
      font-size: 9px;
    }

    .sparkline-container {
      width: 110px;
      height: 40px;
      cursor: pointer;
    }
    .sparkline-caption {
      font-size: 8px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .row-delete-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 13px;
      padding: 0 2px;
    }
    .row-delete-btn:hover { color: #ef4444; }

    .table-footer {
      padding: 5px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border);
      background: #f9fafb;
      font-size: 10px;
      color: var(--text-muted);
    }
    .helper-text {
      font-size: 10px;
      color: var(--text-muted);
      padding: 4px 8px 8px;
    }

    /* モーダル（一覧側の拡大グラフ） */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 12px 16px 16px;
      max-width: 900px;
      width: 95%;
      box-shadow: 0 20px 40px rgba(15,23,42,0.4);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .modal-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }
    .modal-close-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 11px;
      padding: 2px 8px;
      cursor: pointer;
    }
    .modal-close-btn:hover { background: #eef2ff; }
    .modal-chart-container {
      height: 360px;
    }
    .modal-toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 6px;
      font-size: 11px;
    }
    .modal-toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .modal-toggle-row input[type="checkbox"] {
      width: 13px;
      height: 13px;
    }

    /* 2ページ目（詳細ビュー） */
    .detail-page {
      padding: 12px 18px 20px;
    }
    .detail-hero {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
      padding: 16px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 12px 35px rgba(15,23,42,0.12);
      position: relative;
      overflow: hidden;
    }
    .detail-hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(79,70,229,0.12), transparent 55%);
      pointer-events: none;
    }
    .detail-image-wrap {
      padding: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e0e7ff, #f9fafb);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .detail-image-wrap img {
      max-width: 100%;
      max-height: 220px;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(15,23,42,0.25);
    }
    .detail-main {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .detail-brand {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .detail-title {
      font-size: 18px;
      font-weight: 650;
      line-height: 1.4;
    }
    .detail-rating {
      font-size: 12px;
      color: #f59e0b;
    }
    .detail-asin-line {
      font-size: 13px;
      margin-top: 2px;
    }
    .asin-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
    .asin-link:hover { text-decoration: underline; }
    .detail-cat {
      margin-top: 6px;
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }
    .detail-cat-label {
      font-weight: 600;
      color: #4b5563;
    }
    .detail-warning {
      margin-top: 6px;
    }
    .detail-meta-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: #6b7280;
    }
    .detail-meta-item {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      border: 1px solid #e5e7eb;
    }
    .detail-toolbar {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .detail-toolbar input[type="text"] {
      border-radius: 999px;
      border: 1px solid #d4d8ea;
      padding: 3px 8px;
      font-size: 11px;
      min-width: 130px;
    }
    .detail-toolbar button {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 11px;
      cursor: pointer;
      background: #4b6bff;
      color: #fff;
    }

    .detail-lower {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 2.1fr 1.6fr;
      gap: 14px;
    }
    .info-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .info-card-title {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 2px;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      min-width: 140px;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4ff;
      border: 1px solid #e0e7ff;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .chip-label {
      font-size: 10px;
      color: #6b7280;
    }
    .chip-value {
      font-size: 12px;
      font-weight: 600;
    }

    .graph-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 10px 12px 12px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }
    .graph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .graph-title {
      font-size: 12px;
      font-weight: 600;
      color: #1f2937;
    }
    .graph-sub {
      font-size: 11px;
      color: #6b7280;
    }
    .graph-toggle-row {
      margin-top: 2px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }
    .graph-toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .graph-toggle-row input {
      width: 13px;
      height: 13px;
    }
    .graph-canvas-wrap {
      margin-top: 6px;
      height: 240px;
    }
    .keepa-link {
      margin-top: 6px;
      font-size: 11px;
    }
    .keepa-link a {
      color: #2563eb;
      text-decoration: none;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0e7ff;
    }
    .small-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 960px) {
      .detail-hero { grid-template-columns: 1fr; }
      .detail-image-wrap { justify-content: flex-start; }
      .detail-lower { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      .toolbar { padding-inline: 16px; }
      .toolbar input[type="text"] { min-width: 120px; flex: 1; }
      .status { width: 100%; justify-content: flex-start; margin-left: 0; }
      .asin-catalog, .hidden-cols-bar { padding-inline: 16px; }
      .modal-chart-container { height: 260px; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div>
      <h1>MES-AI-A ASINダッシュボード</h1>
      <div class="subtitle">ASINを入力すると、商品情報・利益予測・需給グラフ（180日）などを自動表示します。</div>
    </div>
    <div class="nav-switch-group">
      <button id="btnGoList" class="nav-tab-btn active">1ページ目（一覧）</button>
      <button id="btnGoDetail" class="nav-tab-btn">2ページ目（詳細）</button>
      <div class="status" id="headerStatus"></div>
    </div>
  </header>

  <!-- ======== 1ページ目：一覧 ======== -->
  <div id="pageList">
    <div class="toolbar">
      <div class="toolbar-group">
        <label for="globalAsinInput">ASIN:</label>
        <input id="globalAsinInput" type="text" placeholder="例）B0A0000001" />
        <button id="addRowFromAsinBtn" class="btn-primary">＋ 行を追加</button>
        <button id="addEmptyRowBtn" class="btn-ghost">空行</button>
      </div>
    </div>

    <!-- 登録ASIN一覧 -->
    <div class="asin-catalog" id="asinCatalog"></div>
    <!-- 非表示列一覧 -->
    <div class="hidden-cols-bar" id="hiddenColsBar"></div>

    <!-- 一覧側：拡大グラフモーダル -->
    <div id="demandModalBackdrop" class="modal-backdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div>
            <div>需給推移グラフ（180日）</div>
            <div class="modal-subtitle" id="demandModalSubtitle"></div>
          </div>
          <button id="demandModalCloseBtn" class="modal-close-btn">閉じる</button>
        </div>

        <div class="modal-toggle-row">
          <label>
            <input type="checkbox" id="chkDemandSupply">
            《需要＆供給》（ランキング＋セラー数）
          </label>
          <label>
            <input type="checkbox" id="chkSupplyPrice">
            《供給＆価格》（セラー数＋価格）
          </label>
        </div>

        <div class="modal-chart-container">
          <canvas id="demandModalChart"></canvas>
        </div>
        <div class="modal-subtitle">
          ※チェックボックスで表示する線を切り替えできます。ホバーで詳細数値を確認できます。
        </div>
      </div>
    </div>

    <div class="table-wrapper">
      <div class="table-container">
        <div class="table-scroll">
          <table id="asinTable">
            <thead>
            <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div class="table-footer">
          <div>左端の ASIN を入力すると自動で各項目が埋まります。×ボタンで行の削除も可能です。</div>
          <div>ヘッダーをドラッグすると列の並び替え、ヘッダーの「−」で列を非表示にできます。</div>
        </div>
      </div>
      <div class="helper-text">
        ・実運用では ASIN_DATA をAPI連携などに差し替える想定です。<br>
        ・需給推移列をクリックすると、拡大グラフが表示されます。
      </div>
    </div>
  </div>

  <!-- ======== 2ページ目：詳細ビュー ======== -->
  <div id="pageDetail" style="display:none;">
    <div class="detail-page">
      <div class="detail-hero">
        <div class="detail-image-wrap">
          <img id="detailHeroImage" src="" alt="Product image">
        </div>
        <div class="detail-main">
          <div class="detail-brand" id="detailBrand"></div>
          <div class="detail-title" id="detailTitle"></div>
          <div class="detail-rating" id="detailRating"></div>
          <div class="detail-asin-line">
            ASIN： <a href="#" target="_blank" rel="noopener" id="detailAsinLink" class="asin-link"></a>
          </div>
          <div class="detail-cat" id="detailCategory"></div>
          <div class="detail-warning" id="detailWarning"></div>
          <div class="detail-meta-row" id="detailMetaRow"></div>

          <div class="detail-toolbar">
            <span>表示中のASINを変更：</span>
            <input id="detailAsinInput" type="text" placeholder="例）B0A0000001">
            <button id="detailAsinApplyBtn">更新</button>
          </div>
        </div>
      </div>

      <div class="detail-lower">
        <div class="info-card">
          <div class="info-card-title">利益・価格・在庫のサマリー</div>
          <div class="chip-row" id="detailChipRow1"></div>

          <div class="info-card-title" style="margin-top:4px;">販売指標</div>
          <div class="chip-row" id="detailChipRow2"></div>

          <div class="info-card-title" style="margin-top:4px;">物流・コスト</div>
          <div class="chip-row" id="detailChipRow3"></div>
          <div class="small-note">※ 数値はダミーデータです。本番環境では API やスプレッドシートと連携して更新します。</div>
        </div>

        <div class="graph-card">
          <div class="graph-header">
            <div>
              <div class="graph-title">需給推移（180日）</div>
              <div class="graph-sub">ランキング / セラー数 / 価格</div>
            </div>
            <div class="graph-sub" id="detailGraphAsinLabel"></div>
          </div>
          <div class="graph-toggle-row">
            <label>
              <input type="checkbox" id="detailChkDemandSupply" checked>
              《需要＆供給》ランキング＋セラー数
            </label>
            <label>
              <input type="checkbox" id="detailChkSupplyPrice">
              《供給＆価格》セラー数＋価格
            </label>
          </div>
          <div class="graph-canvas-wrap">
            <canvas id="detailDemandChart"></canvas>
          </div>
          <div class="keepa-link" id="detailKeepaLink"></div>
          <div class="small-note">
            グラフ上にカーソルを合わせると、その時点の詳細な数値（ランキング・セラー数・価格）が表示されます。
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========= ASINデータ（ダミー） ========= */
  const ASIN_DATA = {
    "B0A0000001": {
      ASIN: "B0A0000001",
      "商品画像": "https://via.placeholder.com/240x240?text=Toy+Set",
      "品名": "スーパーアクションヒーロー 5体セット",
      "注意事項（警告系）": "対象年齢6歳以上 / 小さな部品に注意",
      "親カテゴリ": "Toys & Games",
      "サブカテゴリ": "Action Figures",
      "ブランド": "HeroWorks",
      "レビュー評価": "★★★★☆ (523)",
      "レビュー数推移グラフ": "",
      "アメリカASIN": "B0A0000001",
      "日本ASIN": "B0J0000001",
      "JAN": "4900000000001",
      "SKU": "HW-HERO-SET-5",
      "個数": 1,
      "粗利益率予測": "26%",
      "入金額予測": "6,200円",
      "粗利益予測": "1,612円",
      "粗利益": "1,580円",
      "粗利益率": "25%",
      "販売額（ドル）": "$39.99",
      "入金額（円）": "6,200円",
      "入金額計（円）": "6,200円",
      "需給推移": "",
      "30日販売数": 95,
      "90日販売数": 260,
      "180日販売数": 510,
      "予測30日販売数": 110,
      "複数在庫指数45日分": "1.1",
      "複数在庫指数60日分": "1.3",
      "ライバル偏差1": "0.5",
      "ライバル偏差2": "0.9",
      "ライバル増加率": "12%",
      "在庫数": 60,
      "Keepaリンク": "https://keepa.com/#!product/1-B0A0000001",
      "FBA出品": "はい",
      "返品率": "1.8%",
      "過去3月FBA最安値": "$35.90",
      "カートボックス価格": "$39.99",
      "FBA最安値": "$37.50",
      "日本最安値": "¥6,780",
      "日本FBA最安値": "¥6,980",
      "日本自己発送最安値": "¥6,600",
      "仕入れ目安単価": "¥3,700",
      "仕入合計": "¥3,700",
      "仕入計": "¥3,700",
      "重量kg": "1.10",
      "サイズ感": "中型",
      "縦cm": 32,
      "横cm": 26,
      "高さcm": 8,
      "容積重量": "1.20",
      "材質": "プラスチック / 紙",
      "大型": "いいえ",
      "請求重量": "1.20kg",
      "想定送料": "¥1,150",
      "送料": "¥1,120",
      "関税": "¥0"
    },
    "B0A0000002": {
      ASIN: "B0A0000002",
      "商品画像": "https://via.placeholder.com/240x240?text=Puzzle",
      "品名": "ウルトラギャラクシーパズル 2000ピース",
      "注意事項（警告系）": "対象年齢12歳以上",
      "親カテゴリ": "Toys & Games",
      "サブカテゴリ": "Jigsaw Puzzles",
      "ブランド": "GalaxyMind",
      "レビュー評価": "★★★★☆ (312)",
      "レビュー数推移グラフ": "",
      "アメリカASIN": "B0A0000002",
      "日本ASIN": "B0J0000002",
      "JAN": "4900000000002",
      "SKU": "GM-PUZZLE-2000",
      "個数": 1,
      "粗利益率予測": "30%",
      "入金額予測": "4,200円",
      "粗利益予測": "1,260円",
      "粗利益": "1,200円",
      "粗利益率": "29%",
      "販売額（ドル）": "$26.50",
      "入金額（円）": "4,200円",
      "入金額計（円）": "4,200円",
      "需給推移": "",
      "30日販売数": 70,
      "90日販売数": 190,
      "180日販売数": 370,
      "予測30日販売数": 80,
      "複数在庫指数45日分": "1.0",
      "複数在庫指数60日分": "1.1",
      "ライバル偏差1": "0.2",
      "ライバル偏差2": "0.4",
      "ライバル増加率": "5%",
      "在庫数": 45,
      "Keepaリンク": "https://keepa.com/#!product/1-B0A0000002",
      "FBA出品": "はい",
      "返品率": "1.1%",
      "過去3月FBA最安値": "$24.99",
      "カートボックス価格": "$26.50",
      "FBA最安値": "$25.20",
      "日本最安値": "¥3,980",
      "日本FBA最安値": "¥4,280",
      "日本自己発送最安値": "¥3,900",
      "仕入れ目安単価": "¥2,500",
      "仕入合計": "¥2,500",
      "仕入計": "¥2,500",
      "重量kg": "0.90",
      "サイズ感": "小型",
      "縦cm": 28,
      "横cm": 22,
      "高さcm": 6,
      "容積重量": "0.75",
      "材質": "紙",
      "大型": "いいえ",
      "請求重量": "0.90kg",
      "想定送料": "¥900",
      "送料": "¥880",
      "関税": "¥0"
    },
    "B0A0000003": {
      ASIN: "B0A0000003",
      "商品画像": "https://via.placeholder.com/240x240?text=Board+Game",
      "品名": "ストラテジーボードゲーム ネオ・シティ",
      "注意事項（警告系）": "対象年齢10歳以上 / 3人〜5人用",
      "親カテゴリ": "Toys & Games",
      "サブカテゴリ": "Board Games",
      "ブランド": "NeoPlay",
      "レビュー評価": "★★★★★ (198)",
      "レビュー数推移グラフ": "",
      "アメリカASIN": "B0A0000003",
      "日本ASIN": "B0J0000003",
      "JAN": "4900000000003",
      "SKU": "NP-BOARD-NEOCITY",
      "個数": 1,
      "粗利益率予測": "32%",
      "入金額予測": "5,800円",
      "粗利益予測": "1,856円",
      "粗利益": "1,820円",
      "粗利益率": "31%",
      "販売額（ドル）": "$35.00",
      "入金額（円）": "5,800円",
      "入金額計（円）": "5,800円",
      "需給推移": "",
      "30日販売数": 55,
      "90日販売数": 150,
      "180日販売数": 290,
      "予測30日販売数": 65,
      "複数在庫指数45日分": "1.3",
      "複数在庫指数60日分": "1.5",
      "ライバル偏差1": "0.6",
      "ライバル偏差2": "1.0",
      "ライバル増加率": "10%",
      "在庫数": 40,
      "Keepaリンク": "https://keepa.com/#!product/1-B0A0000003",
      "FBA出品": "はい",
      "返品率": "1.6%",
      "過去3月FBA最安値": "$32.00",
      "カートボックス価格": "$35.00",
      "FBA最安値": "$33.50",
      "日本最安値": "¥5,980",
      "日本FBA最安値": "¥6,280",
      "日本自己発送最安値": "¥5,700",
      "仕入れ目安単価": "¥3,200",
      "仕入合計": "¥3,200",
      "仕入計": "¥3,200",
      "重量kg": "1.30",
      "サイズ感": "中型",
      "縦cm": 34,
      "横cm": 26,
      "高さcm": 7,
      "容積重量": "1.40",
      "材質": "紙 / プラスチック",
      "大型": "いいえ",
      "請求重量": "1.40kg",
      "想定送料": "¥1,200",
      "送料": "¥1,160",
      "関税": "¥0"
    }
  };

  /* ========= テーブル構造定義 ========= */
  const BASE_COLUMNS = [
    { id: "ASIN", label: "ASIN", type: "asinInput", visible: true },
    { id: "商品画像", label: "商品画像", type: "image", visible: true },
    { id: "品名", label: "品名", visible: true },

    { id: "親カテゴリ", label: "親カテゴリ", visible: false },
    { id: "サブカテゴリ", label: "サブカテゴリ", visible: false },
    { id: "カテゴリまとめ", label: "カテゴリ", type: "category", visible: true },

    { id: "ブランド", label: "ブランド", visible: true },
    { id: "レビュー評価", label: "レビュー<br>評価", visible: true },
    { id: "レビュー数推移グラフ", label: "レビュー数<br>推移グラフ", visible: false },
    { id: "アメリカASIN", label: "アメリカ<br>ASIN", visible: true },
    { id: "日本ASIN", label: "日本ASIN", visible: false },
    { id: "JAN", label: "JAN", visible: false },
    { id: "SKU", label: "SKU", visible: false },
    { id: "個数", label: "個数", visible: true },
    { id: "粗利益率予測", label: "粗利益率<br>予測", visible: true },
    { id: "入金額予測", label: "入金額<br>予測", visible: true },
    { id: "粗利益予測", label: "粗利益<br>予測", visible: true },
    { id: "粗利益", label: "粗利益", visible: false },
    { id: "粗利益率", label: "粗利益率", visible: false },
    { id: "販売額（ドル）", label: "販売額（ドル）", visible: true },
    { id: "入金額（円）", label: "入金額（円）", visible: true },
    { id: "入金額計（円）", label: "入金額計（円）", visible: false },
    {
      id: "需給推移",
      label: "需給推移<br>□《需要＆供給》<br>□《供給＆価格》",
      visible: true
    },
    { id: "30日販売数", label: "30日<br>販売数", visible: true },
    { id: "90日販売数", label: "90日<br>販売数", visible: false },
    { id: "180日販売数", label: "180日<br>販売数", visible: false },
    { id: "予測30日販売数", label: "予測<br>30日<br>販売数", visible: true },

    { id: "複数在庫指数45日分", label: "複数在庫指数45", visible: false },
    { id: "複数在庫指数60日分", label: "複数在庫指数60", visible: false },
    { id: "複数在庫指数まとめ", label: "複数在庫指数", type: "multiIndex", visible: true },

    { id: "ライバル偏差1", label: "ライバル偏差×1", visible: false },
    { id: "ライバル偏差2", label: "ライバル偏差×2", visible: false },
    { id: "ライバル偏差まとめ", label: "ライバル偏差", type: "rivalBias", visible: true },

    { id: "ライバル増加率", label: "ライバル<br>増加率", visible: false },
    { id: "在庫数", label: "在庫数", visible: true },
    { id: "Keepaリンク", label: "Keepa<br>(アメリカAmazon)", visible: true },
    { id: "FBA出品", label: "FBA出品", visible: true },
    { id: "返品率", label: "返品率", visible: false },
    { id: "過去3月FBA最安値", label: "過去3月<br>FBA最安値", visible: false },
    { id: "カートボックス価格", label: "カートボックス<br>価格", visible: true },
    { id: "FBA最安値", label: "FBA最安値", visible: false },
    { id: "日本最安値", label: "日本最安値", visible: false },
    { id: "日本FBA最安値", label: "日本FBA<br>最安値", visible: false },
    { id: "日本自己発送最安値", label: "日本自己<br>発送最安値", visible: false },
    { id: "仕入れ目安単価", label: "仕入れ<br>目安単価", visible: true },
    { id: "仕入合計", label: "仕入合計", visible: false },
    { id: "仕入計", label: "仕入計", visible: false },
    { id: "重量kg", label: "重量<br>（kg）", visible: true },

    { id: "サイズまとめ", label: "サイズ<br>(縦×横×高さ)", type: "size", visible: true },
    { id: "サイズ感", label: "サイズ感", visible: false },
    { id: "縦cm", label: "縦cm", visible: false },
    { id: "横cm", label: "横cm", visible: false },
    { id: "高さcm", label: "高さcm", visible: false },

    { id: "容積重量", label: "容積重量", visible: false },
    { id: "材質", label: "材質", visible: false },
    { id: "大型", label: "大型", visible: false },
    { id: "請求重量", label: "請求重量", visible: false },
    { id: "想定送料", label: "想定送料", visible: true },
    { id: "送料", label: "送料", visible: false },
    { id: "関税", label: "関税", visible: false },
    { id: "_ROW_ACTIONS", label: " ", type: "rowActions", visible: true }
  ];
  let columns = BASE_COLUMNS.map(c => ({ ...c }));

  const headerRow = document.getElementById("tableHeaderRow");
  const tbody = document.getElementById("tableBody");
  const headerStatus = document.getElementById("headerStatus");
  const asinCatalog = document.getElementById("asinCatalog");
  const hiddenColsBar = document.getElementById("hiddenColsBar");

  const demandModalBackdrop = document.getElementById("demandModalBackdrop");
  const demandModalCloseBtn = document.getElementById("demandModalCloseBtn");
  const demandModalSubtitle = document.getElementById("demandModalSubtitle");
  const demandModalChartCanvas = document.getElementById("demandModalChart");
  const chkDemandSupply = document.getElementById("chkDemandSupply");
  const chkSupplyPrice = document.getElementById("chkSupplyPrice");
  let demandModalChartInstance = null;

  const globalInput = document.getElementById("globalAsinInput");
  const addRowFromAsinBtn = document.getElementById("addRowFromAsinBtn");
  const addEmptyRowBtn = document.getElementById("addEmptyRowBtn");

  const pageList = document.getElementById("pageList");
  const pageDetail = document.getElementById("pageDetail");
  const btnGoList = document.getElementById("btnGoList");
  const btnGoDetail = document.getElementById("btnGoDetail");

  let dragColId = null;

  function visibleColumns() { return columns.filter(c => c.visible !== false); }

  /* ==== 疑似乱数＋需給データ ==== */
  function createPRNG(seedStr) {
    let seed = 0;
    for (let i = 0; i < seedStr.length; i++) seed += seedStr.charCodeAt(i);
    return function () {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };
  }
  function getDemandSupplySeries(asin) {
    const rand = createPRNG(asin);
    const days = 180;
    const labels = [];
    const ranking = [];
    const sellers = [];
    const price = [];
    let rank = 60000 * (0.6 + rand() * 0.4);
    let seller = 5 + Math.round(rand() * 5);
    let p = 25 + rand() * 30;

    for (let i = days - 1; i >= 0; i--) {
      labels.push(`${i}日前`);
      rank += (rand() - 0.5) * 4000;
      rank = Math.max(5000, Math.min(80000, rank));
      seller += (rand() - 0.5) * 2;
      seller = Math.max(1, Math.min(25, seller));
      p += (rand() - 0.5) * 2;
      p = Math.max(10, Math.min(80, p));
      ranking.push(Math.round(rank));
      sellers.push(Number(seller.toFixed(1)));
      price.push(Number(p.toFixed(2)));
    }
    labels.reverse(); ranking.reverse(); sellers.reverse(); price.reverse();
    return { labels, ranking, sellers, price };
  }

  /* ==== ヘッダー生成 ==== */
  function buildHeader() {
    headerRow.innerHTML = "";
    visibleColumns().forEach(col => {
      const th = document.createElement("th");
      th.dataset.colId = col.id;
      th.draggable = col.id !== "_ROW_ACTIONS";

      const inner = document.createElement("div");
      inner.className = "th-inner";

      const labelSpan = document.createElement("span");
      labelSpan.className = "th-label";
      labelSpan.innerHTML = col.label;
      inner.appendChild(labelSpan);

      if (col.id !== "ASIN" && col.id !== "_ROW_ACTIONS") {
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "th-toggle";
        toggleBtn.textContent = "−";
        toggleBtn.title = "この列を非表示にする";
        toggleBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          col.visible = false;
          rebuildTableFromCurrentRows();
          renderHiddenColsBar();
        });
        inner.appendChild(toggleBtn);
      }

      th.appendChild(inner);
      headerRow.appendChild(th);

      if (th.draggable) {
        th.addEventListener("dragstart", (e) => {
          dragColId = col.id;
          e.dataTransfer.effectAllowed = "move";
        });
        th.addEventListener("dragover", (e) => {
          e.preventDefault();
          th.classList.add("drag-over");
          e.dataTransfer.dropEffect = "move";
        });
        th.addEventListener("dragleave", () => {
          th.classList.remove("drag-over");
        });
        th.addEventListener("drop", (e) => {
          e.preventDefault();
          th.classList.remove("drag-over");
          const targetId = col.id;
          if (!dragColId || dragColId === targetId) return;
          const srcIndex = columns.findIndex(c => c.id === dragColId);
          const dstIndex = columns.findIndex(c => c.id === targetId);
          if (srcIndex === -1 || dstIndex === -1) return;
          const [moved] = columns.splice(srcIndex, 1);
          columns.splice(dstIndex, 0, moved);
          dragColId = null;
          rebuildTableFromCurrentRows();
          renderHiddenColsBar();
        });
      }
    });
  }

  function createRow(presetAsin = "") {
    const tr = document.createElement("tr");
    visibleColumns().forEach(col => {
      const td = document.createElement("td");
      td.dataset.colId = col.id;

      if (col.type === "asinInput") {
        td.classList.add("input-cell");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "asin-input";
        input.placeholder = "ASIN";
        input.value = presetAsin;
        input.addEventListener("change", () => handleAsinChange(tr, input.value));
        input.addEventListener("blur", () => handleAsinChange(tr, input.value));
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            handleAsinChange(tr, input.value);
          }
        });
        td.appendChild(input);
      } else if (col.type === "rowActions") {
        const btn = document.createElement("button");
        btn.className = "row-delete-btn";
        btn.innerHTML = "×";
        btn.title = "この行を削除";
        btn.addEventListener("click", () => tr.remove());
        td.appendChild(btn);
      } else {
        td.classList.add("readonly-cell");
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
    if (presetAsin) handleAsinChange(tr, presetAsin);
    return tr;
  }

  function handleAsinChange(row, rawAsin) {
    const asin = String(rawAsin || "").trim().toUpperCase();
    const data = ASIN_DATA[asin];

    const asinInputCell = row.querySelector('td[data-col-id="ASIN"] input.asin-input');
    if (asinInputCell && asinInputCell.value !== asin) {
      asinInputCell.value = asin;
    }

    if (!data) {
      visibleColumns().forEach(col => {
        if (col.id === "ASIN" || col.type === "rowActions") return;
        const cell = row.querySelector(`td[data-col-id="${col.id}"]`);
        if (!cell) return;
        cell.innerHTML = "";
      });
      row.dataset.loaded = "false";
      return;
    }

    visibleColumns().forEach(col => {
      if (col.id === "ASIN" || col.type === "rowActions") return;
      const cell = row.querySelector(`td[data-col-id="${col.id}"]`);
      if (!cell) return;

      if (col.type === "category") {
        cell.classList.add("multi-line");
        const parent = data["親カテゴリ"] || "-";
        const child = data["サブカテゴリ"] || "-";
        cell.innerHTML = `【カテゴリ】<br>親：${parent}<br>子：${child}`;
        return;
      }
      if (col.type === "multiIndex") {
        cell.classList.add("multi-line");
        const v45 = data["複数在庫指数45日分"] ?? "-";
        const v60 = data["複数在庫指数60日分"] ?? "-";
        cell.innerHTML = `【複数在庫指数】<br>45日：${v45}<br>60日：${v60}`;
        return;
      }
      if (col.type === "rivalBias") {
        cell.classList.add("multi-line");
        const v1 = data["ライバル偏差1"] ?? "-";
        const v2 = data["ライバル偏差2"] ?? "-";
        cell.innerHTML = `【ライバル偏差】<br>×1：${v1}<br>×2：${v2}`;
        return;
      }
      if (col.type === "size") {
        const v = data["縦cm"];
        const h = data["横cm"];
        const t = data["高さcm"];
        if (v != null && h != null && t != null) cell.textContent = `${v}×${h}×${t}`;
        else cell.textContent = "";
        return;
      }

      const value = data[col.id] ?? "";

      if (col.type === "image") {
        cell.innerHTML = "";
        if (value) {
          const img = document.createElement("img");
          img.src = value;
          img.alt = data["品名"] || asin;
          img.className = "product-image";
          cell.appendChild(img);
        }
      } else if (col.id === "FBA出品") {
        cell.innerHTML = "";
        if (value) {
          const pill = document.createElement("span");
          pill.className = "pill " + (String(value).includes("はい") ? "pill-ok" : "pill-danger");
          pill.textContent = value;
          cell.appendChild(pill);
        }
      } else if (col.id === "Keepaリンク") {
        cell.innerHTML = "";
        if (value) {
          const a = document.createElement("a");
          a.href = value;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Keepa";
          a.className = "pill";
          cell.appendChild(a);
        }
      } else if (col.id === "需給推移") {
        cell.innerHTML = "";
        renderDemandSparkline(cell, asin);
      } else {
        cell.textContent = value;
      }
    });

    row.dataset.loaded = "true";
  }

  function getCurrentRowAsins() {
    return Array.from(tbody.querySelectorAll("tr")).map(tr => {
      const input = tr.querySelector('td[data-col-id="ASIN"] input.asin-input');
      return input ? String(input.value || "").trim().toUpperCase() : "";
    });
  }

  function rebuildTableFromCurrentRows() {
    const asins = getCurrentRowAsins();
    tbody.innerHTML = "";
    buildHeader();
    asins.forEach(asin => createRow(asin));
  }

  /* ==== ミニグラフ ==== */
  function renderDemandSparkline(cell, asin) {
    if (!ASIN_DATA[asin]) {
      cell.textContent = "";
      return;
    }
    const container = document.createElement("div");
    container.className = "sparkline-container";

    const canvas = document.createElement("canvas");
    canvas.width = 110;
    canvas.height = 40;
    container.appendChild(canvas);

    const caption = document.createElement("div");
    caption.className = "sparkline-caption";
    caption.textContent = "Rank / Seller / Price";
    cell.appendChild(container);
    cell.appendChild(caption);

    const data = getDemandSupplySeries(asin);

    new Chart(canvas.getContext("2d"), {
      type: "line",
      data: {
        labels: data.labels,
        datasets: [
          { label: "ランキング", data: data.ranking, borderWidth: 1, pointRadius: 0, tension: 0.2, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: data.sellers, borderWidth: 1, pointRadius: 0, tension: 0.2, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格", data: data.price, borderWidth: 1, pointRadius: 0, tension: 0.2, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: { display: false },
          yRank: { display: false },
          ySeller: { display: false },
          yPrice: { display: false }
        }
      }
    });

    container.addEventListener("click", () => openDemandModal(asin, data));
  }

  /* ==== 一覧モーダル ==== */
  function applyModalCheckboxVisibility() {
    if (!demandModalChartInstance) return;
    const ds = demandModalChartInstance.data.datasets;

    let showRank = true;
    let showSeller = true;
    let showPrice = true;

    const demandOn = chkDemandSupply.checked;
    const supplyPriceOn = chkSupplyPrice.checked;

    if (demandOn && !supplyPriceOn) {
      showRank = true; showSeller = true; showPrice = false;
    } else if (!demandOn && supplyPriceOn) {
      showRank = false; showSeller = true; showPrice = true;
    } else if (demandOn && supplyPriceOn) {
      showRank = true; showSeller = true; showPrice = true;
    } else {
      showRank = true; showSeller = true; showPrice = true;
    }

    ds[0].hidden = !showRank;
    ds[1].hidden = !showSeller;
    ds[2].hidden = !showPrice;

    demandModalChartInstance.update();
  }

  function openDemandModal(asin, data) {
    const asinData = ASIN_DATA[asin];
    demandModalSubtitle.textContent = `ASIN: ${asin}　${asinData ? asinData["品名"] : ""}`;
    demandModalBackdrop.classList.add("open");

    if (demandModalChartInstance) {
      demandModalChartInstance.destroy();
      demandModalChartInstance = null;
    }
    const ctx = demandModalChartCanvas.getContext("2d");
    demandModalChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: data.labels,
        datasets: [
          { label: "ランキング（小さいほど上位）", data: data.ranking, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: data.sellers, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格（USD）", data: data.price, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label || "";
                if (ctx.dataset.yAxisID === "yPrice") return `${label}: $${ctx.parsed.y.toFixed(2)}`;
                return `${label}: ${ctx.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: { display: true, ticks: { maxTicksLimit: 12 } },
          yRank: { type: "linear", position: "left", reverse: true, title: { display: true, text: "ランキング" } },
          ySeller: { type: "linear", position: "right", title: { display: true, text: "セラー数" }, grid: { drawOnChartArea: false } },
          yPrice: { type: "linear", position: "right", offset: true, title: { display: true, text: "価格(USD)" }, grid: { drawOnChartArea: false } }
        }
      }
    });

    chkDemandSupply.checked = true;
    chkSupplyPrice.checked = false;
    applyModalCheckboxVisibility();
  }

  demandModalBackdrop.addEventListener("click", () => {
    demandModalBackdrop.classList.remove("open");
  });
  demandModalCloseBtn.addEventListener("click", () => {
    demandModalBackdrop.classList.remove("open");
  });
  chkDemandSupply.addEventListener("change", applyModalCheckboxVisibility);
  chkSupplyPrice.addEventListener("change", applyModalCheckboxVisibility);

  /* ==== 非表示列バー ==== */
  function renderHiddenColsBar() {
    const hiddenCols = columns.filter(c => !c.visible && c.id !== "ASIN" && c.id !== "_ROW_ACTIONS");
    hiddenColsBar.innerHTML = "";
    if (!hiddenCols.length) {
      hiddenColsBar.style.display = "none";
      return;
    }
    hiddenColsBar.style.display = "flex";
    hiddenCols.forEach(col => {
      const pill = document.createElement("div");
      pill.className = "hidden-col-pill";
      pill.innerHTML = `<span>${col.id}</span>`;
      const btn = document.createElement("button");
      btn.textContent = "＋";
      btn.title = "この列を再表示";
      btn.addEventListener("click", () => {
        col.visible = true;
        rebuildTableFromCurrentRows();
        renderHiddenColsBar();
      });
      pill.appendChild(btn);
      hiddenColsBar.appendChild(pill);
    });
  }

  /* ==== ASIN一覧・ステータス ==== */
  function buildAsinCatalogAndStatus() {
    const asins = Object.keys(ASIN_DATA || {});
    headerStatus.textContent = `登録ASIN数：${asins.length}件`;
    asinCatalog.innerHTML = "";
    if (!asins.length) return;
    const label = document.createElement("span");
    label.className = "asin-catalog-label";
    label.textContent = "データがあるASIN：";
    asinCatalog.appendChild(label);
    asins.forEach(a => {
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = a;
      asinCatalog.appendChild(span);
    });
  }

  /* ==== 2ページ目：詳細ビューの描画 ==== */
  const detailHeroImage = document.getElementById("detailHeroImage");
  const detailBrand = document.getElementById("detailBrand");
  const detailTitle = document.getElementById("detailTitle");
  const detailRating = document.getElementById("detailRating");
  const detailAsinLink = document.getElementById("detailAsinLink");
  const detailCategory = document.getElementById("detailCategory");
  const detailWarning = document.getElementById("detailWarning");
  const detailMetaRow = document.getElementById("detailMetaRow");
  const detailChipRow1 = document.getElementById("detailChipRow1");
  const detailChipRow2 = document.getElementById("detailChipRow2");
  const detailChipRow3 = document.getElementById("detailChipRow3");
  const detailGraphAsinLabel = document.getElementById("detailGraphAsinLabel");
  const detailKeepaLink = document.getElementById("detailKeepaLink");
  const detailAsinInput = document.getElementById("detailAsinInput");
  const detailAsinApplyBtn = document.getElementById("detailAsinApplyBtn");
  const detailChkDemandSupply = document.getElementById("detailChkDemandSupply");
  const detailChkSupplyPrice = document.getElementById("detailChkSupplyPrice");
  const detailDemandChartCanvas = document.getElementById("detailDemandChart");
  let detailDemandChart = null;

  function addChip(rowEl, label, value) {
    const chip = document.createElement("div");
    chip.className = "chip";
    const l = document.createElement("div");
    l.className = "chip-label";
    l.textContent = label;
    const v = document.createElement("div");
    v.className = "chip-value";
    v.textContent = value || "-";
    chip.appendChild(l); chip.appendChild(v);
    rowEl.appendChild(chip);
  }

  function renderDetailPage(asinRaw) {
    const asin = (asinRaw || "").toUpperCase();
    const data = ASIN_DATA[asin] || ASIN_DATA[Object.keys(ASIN_DATA)[0]];

    if (!data) return;

    detailHeroImage.src = data["商品画像"] || "https://via.placeholder.com/240x240?text=No+Image";
    detailBrand.textContent = data["ブランド"] || "";
    detailTitle.textContent = data["品名"] || "";
    detailRating.textContent = data["レビュー評価"] || "";
    detailAsinLink.textContent = data["アメリカASIN"] || data.ASIN;
    detailAsinLink.href = `https://www.amazon.com/dp/${data["アメリカASIN"] || data.ASIN}`;
    detailCategory.innerHTML =
      `<span class="detail-cat-label">【カテゴリ】</span><br>` +
      `親：${data["親カテゴリ"] || "-"}<br>` +
      `子：${data["サブカテゴリ"] || "-"}`;

    detailWarning.innerHTML = "";
    if (data["注意事項（警告系）"]) {
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = data["注意事項（警告系）"];
      detailWarning.appendChild(span);
    }

    detailMetaRow.innerHTML = "";
    [["SKU", data["SKU"]],["JAN", data["JAN"]],["日本ASIN", data["日本ASIN"]],["FBA出品", data["FBA出品"]]].forEach(([label,val])=>{
      if (!val) return;
      const div = document.createElement("div");
      div.className = "detail-meta-item";
      div.textContent = `${label}: ${val}`;
      detailMetaRow.appendChild(div);
    });

    detailAsinInput.value = data.ASIN;
    detailChipRow1.innerHTML = "";
    detailChipRow2.innerHTML = "";
    detailChipRow3.innerHTML = "";

    addChip(detailChipRow1, "販売額（ドル）", data["販売額（ドル）"]);
    addChip(detailChipRow1, "カートボックス価格", data["カートボックス価格"]);
    addChip(detailChipRow1, "粗利益率予測", data["粗利益率予測"]);
    addChip(detailChipRow1, "粗利益予測", data["粗利益予測"]);
    addChip(detailChipRow1, "仕入れ目安単価", data["仕入れ目安単価"]);
    addChip(detailChipRow1, "在庫数", data["在庫数"]);

    addChip(detailChipRow2, "30日販売数", data["30日販売数"]);
    addChip(detailChipRow2, "90日販売数", data["90日販売数"]);
    addChip(detailChipRow2, "180日販売数", data["180日販売数"]);
    addChip(detailChipRow2, "予測30日販売数", data["予測30日販売数"]);
    addChip(detailChipRow2, "複数在庫指数", `45日：${data["複数在庫指数45日分"] ?? "-"} / 60日：${data["複数在庫指数60日分"] ?? "-"}`);
    addChip(detailChipRow2, "ライバル偏差", `×1：${data["ライバル偏差1"] ?? "-"} / ×2：${data["ライバル偏差2"] ?? "-"}`);

    addChip(detailChipRow3, "重量(kg)", data["重量kg"]);
    if (data["縦cm"] != null && data["横cm"] != null && data["高さcm"] != null) {
      addChip(detailChipRow3, "サイズ(縦×横×高)", `${data["縦cm"]}×${data["横cm"]}×${data["高さcm"]} cm`);
    }
    addChip(detailChipRow3, "容積重量", data["容積重量"]);
    addChip(detailChipRow3, "想定送料", data["想定送料"]);
    addChip(detailChipRow3, "送料", data["送料"]);
    addChip(detailChipRow3, "関税", data["関税"]);

    detailKeepaLink.innerHTML = "";
    if (data["Keepaリンク"]) {
      detailKeepaLink.innerHTML = `<a href="${data["Keepaリンク"]}" target="_blank" rel="noopener">Keepa で詳細を見る</a>`;
    }

    detailGraphAsinLabel.textContent = `ASIN: ${data.ASIN}`;

    const series = getDemandSupplySeries(data.ASIN);
    if (detailDemandChart) detailDemandChart.destroy();
    detailDemandChart = new Chart(detailDemandChartCanvas.getContext("2d"), {
      type: "line",
      data: {
        labels: series.labels,
        datasets: [
          { label: "ランキング（小さいほど上位）", data: series.ranking, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#60a5fa", yAxisID: "yRank" },
          { label: "セラー数", data: series.sellers, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#22c55e", yAxisID: "ySeller" },
          { label: "価格（USD）", data: series.price, borderWidth: 2, pointRadius: 0, tension: 0.25, borderColor: "#f97316", yAxisID: "yPrice" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label || "";
                if (ctx.dataset.yAxisID === "yPrice") return `${label}: $${ctx.parsed.y.toFixed(2)}`;
                return `${label}: ${ctx.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: { display: true, ticks: { maxTicksLimit: 10 } },
          yRank: { type: "linear", position: "left", reverse: true, title: { display: true, text: "ランキング" } },
          ySeller: { type: "linear", position: "right", title: { display: true, text: "セラー数" }, grid: { drawOnChartArea: false } },
          yPrice: { type: "linear", position: "right", offset: true, title: { display: true, text: "価格(USD)" }, grid: { drawOnChartArea: false } }
        }
      }
    });

    detailChkDemandSupply.checked = true;
    detailChkSupplyPrice.checked = false;
    applyDetailCheckboxVisibility();
  }

  function applyDetailCheckboxVisibility() {
    if (!detailDemandChart) return;
    const demandOn = detailChkDemandSupply.checked;
    const supplyOn = detailChkSupplyPrice.checked;
    let showRank = true, showSeller = true, showPrice = true;

    if (demandOn && !supplyOn) { showRank = true; showSeller = true; showPrice = false; }
    else if (!demandOn && supplyOn) { showRank = false; showSeller = true; showPrice = true; }
    else if (demandOn && supplyOn) { showRank = true; showSeller = true; showPrice = true; }
    else { showRank = true; showSeller = true; showPrice = true; }

    detailDemandChart.data.datasets[0].hidden = !showRank;
    detailDemandChart.data.datasets[1].hidden = !showSeller;
    detailDemandChart.data.datasets[2].hidden = !showPrice;
    detailDemandChart.update();
  }

  detailChkDemandSupply.addEventListener("change", applyDetailCheckboxVisibility);
  detailChkSupplyPrice.addEventListener("change", applyDetailCheckboxVisibility);
  detailAsinApplyBtn.addEventListener("click", () => renderDetailPage(detailAsinInput.value));

  /* ==== ページ切替 ==== */
  function showPage(which) {
    if (which === "list") {
      pageList.style.display = "";
      pageDetail.style.display = "none";
      btnGoList.classList.add("active");
      btnGoDetail.classList.remove("active");
    } else {
      pageList.style.display = "none";
      pageDetail.style.display = "";
      btnGoDetail.classList.add("active");
      btnGoList.classList.remove("active");
    }
  }

  btnGoList.addEventListener("click", () => showPage("list"));
  btnGoDetail.addEventListener("click", () => {
    // テーブルの最初のASIN or データの先頭ASIN
    const currentAsins = getCurrentRowAsins().filter(a => a);
    const asin = currentAsins[0] || Object.keys(ASIN_DATA)[0];
    renderDetailPage(asin);
    showPage("detail");
  });

  /* ==== 初期化 ==== */
  buildAsinCatalogAndStatus();
  buildHeader();
  renderHiddenColsBar();
  createRow();

  addRowFromAsinBtn.addEventListener("click", () => {
    const asin = globalInput.value.trim();
    if (!asin) {
      const row = createRow();
      const input = row.querySelector('td[data-col-id="ASIN"] input.asin-input');
      if (input) input.focus();
      return;
    }
    createRow(asin);
    globalInput.value = "";
  });

  addEmptyRowBtn.addEventListener("click", () => {
    const row = createRow();
    const input = row.querySelector('td[data-col-id="ASIN"] input.asin-input');
    if (input) input.focus();
  });
</script>
</body>
</html>
